# DNS Poisoning Vulnerability Lab

apiVersion: v1
kind: Namespace
metadata:
  name: dns-poisoning-lab
  labels:
    name: dns-poisoning-lab
    purpose: dns-poisoning-testing
    security-level: high-risk
---
# VULNERABLE: Service account with excessive permissions for DNS poisoning
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dns-poisoning-sa
  namespace: dns-poisoning-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for DNS poisoning
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dns-poisoning-role
  namespace: dns-poisoning-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dns-poisoning-role-binding
  namespace: dns-poisoning-lab
subjects:
- kind: ServiceAccount
  name: dns-poisoning-sa
  namespace: dns-poisoning-lab
roleRef:
  kind: Role
  name: dns-poisoning-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Malicious DNS server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: malicious-dns-server
  namespace: dns-poisoning-lab
  labels:
    app: malicious-dns-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: malicious-dns-server
  template:
    metadata:
      labels:
        app: malicious-dns-server
    spec:
      serviceAccountName: dns-poisoning-sa
      hostNetwork: true  # VULNERABLE: Host network access
      hostPID: true  # VULNERABLE: Host PID namespace
      hostIPC: true  # VULNERABLE: Host IPC namespace
      securityContext:
        runAsUser: 0  # VULNERABLE: Running as root
        runAsGroup: 0
        runAsNonRoot: false  # VULNERABLE: Not running as non-root
        allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
        privileged: true  # VULNERABLE: Privileged container
        capabilities:
          add:
          - ALL  # VULNERABLE: All capabilities
          drop: []
        readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
      containers:
      - name: malicious-dns-container
        image: alpine:latest
        command: ["/bin/sh"]
        args: ["-c", "while true; do echo 'Malicious DNS server running...' > /tmp/dns.log; sleep 3600; done"]
        ports:
        - containerPort: 53
          protocol: UDP
        - containerPort: 53
          protocol: TCP
        env:
        - name: DNS_POISONING
          value: "enabled"
        - name: MALICIOUS_RECORDS
          value: "active"
        - name: CACHE_POISONING
          value: "enabled"
        securityContext:
          runAsUser: 0  # VULNERABLE: Running as root
          runAsGroup: 0
          runAsNonRoot: false  # VULNERABLE: Not running as non-root
          allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
          privileged: true  # VULNERABLE: Privileged container
          capabilities:
            add:
            - ALL  # VULNERABLE: All capabilities
            drop: []
          readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
        volumeMounts:
        - name: dns-config
          mountPath: /etc/dns
          readOnly: false  # VULNERABLE: Writable DNS config
        - name: dns-cache
          mountPath: /var/cache/dns
          readOnly: false  # VULNERABLE: Writable DNS cache
        - name: host-etc
          mountPath: /host/etc
          readOnly: false  # VULNERABLE: Writable host mount
      volumes:
      - name: dns-config
        hostPath:
          path: /tmp/dns-config
      - name: dns-cache
        hostPath:
          path: /tmp/dns-cache
      - name: host-etc
        hostPath:
          path: /etc  # VULNERABLE: Host path mount
---
# VULNERABLE: DNS cache poisoning pod
apiVersion: v1
kind: Pod
metadata:
  name: dns-cache-poisoning
  namespace: dns-poisoning-lab
  labels:
    app: dns-cache-poisoning
    security-level: critical
spec:
  serviceAccountName: dns-poisoning-sa
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
    privileged: true  # VULNERABLE: Privileged container
    capabilities:
      add:
      - ALL  # VULNERABLE: All capabilities
      drop: []
    readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
  containers:
  - name: cache-poisoning-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'DNS cache poisoning...' > /tmp/poison.log; sleep 3600; done"]
    env:
    - name: CACHE_POISONING
      value: "enabled"
    - name: DNS_SPOOFING
      value: "active"
    - name: MALICIOUS_RECORDS
      value: "injected"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: dns-cache
      mountPath: /var/cache/dns
      readOnly: false  # VULNERABLE: Writable DNS cache
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var
      mountPath: /host/var
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: dns-cache
    hostPath:
      path: /tmp/dns-cache
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-var
    hostPath:
      path: /var  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: DNS hijacking pod
apiVersion: v1
kind: Pod
metadata:
  name: dns-hijacking
  namespace: dns-poisoning-lab
  labels:
    app: dns-hijacking
    security-level: critical
spec:
  serviceAccountName: dns-poisoning-sa
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
    privileged: true  # VULNERABLE: Privileged container
    capabilities:
      add:
      - ALL  # VULNERABLE: All capabilities
      drop: []
    readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
  containers:
  - name: dns-hijacking-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'DNS hijacking...' > /tmp/hijack.log; sleep 3600; done"]
    env:
    - name: DNS_HIJACKING
      value: "enabled"
    - name: TRAFFIC_REDIRECTION
      value: "active"
    - name: MALICIOUS_REDIRECT
      value: "enabled"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: dns-hijack-config
      mountPath: /etc/dns-hijack
      readOnly: false  # VULNERABLE: Writable hijack config
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var
      mountPath: /host/var
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: dns-hijack-config
    hostPath:
      path: /tmp/dns-hijack-config
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-var
    hostPath:
      path: /var  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: DNS spoofing pod
apiVersion: v1
kind: Pod
metadata:
  name: dns-spoofing
  namespace: dns-poisoning-lab
  labels:
    app: dns-spoofing
    security-level: critical
spec:
  serviceAccountName: dns-poisoning-sa
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
    privileged: true  # VULNERABLE: Privileged container
    capabilities:
      add:
      - ALL  # VULNERABLE: All capabilities
      drop: []
    readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
  containers:
  - name: dns-spoofing-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'DNS spoofing...' > /tmp/spoof.log; sleep 3600; done"]
    env:
    - name: DNS_SPOOFING
      value: "enabled"
    - name: FAKE_RECORDS
      value: "active"
    - name: MALICIOUS_REDIRECT
      value: "enabled"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: dns-spoof-config
      mountPath: /etc/dns-spoof
      readOnly: false  # VULNERABLE: Writable spoof config
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var
      mountPath: /host/var
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: dns-spoof-config
    hostPath:
      path: /tmp/dns-spoof-config
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-var
    hostPath:
      path: /var  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Service exposing malicious DNS server
apiVersion: v1
kind: Service
metadata:
  name: malicious-dns-server
  namespace: dns-poisoning-lab
  labels:
    app: malicious-dns-server
spec:
  type: NodePort
  selector:
    app: malicious-dns-server
  ports:
  - name: dns-udp
    port: 53
    targetPort: 53
    nodePort: 30086
    protocol: UDP
  - name: dns-tcp
    port: 53
    targetPort: 53
    nodePort: 30087
    protocol: TCP
---
# VULNERABLE: ConfigMap with DNS poisoning scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: dns-poisoning-scripts
  namespace: dns-poisoning-lab
data:
  poison.sh: |
    #!/bin/bash
    # DNS poisoning script
    echo "Starting DNS poisoning..." > /tmp/poison.log
    # Simulate DNS poisoning
    echo "127.0.0.1 malicious.example.com" >> /host/etc/hosts
    echo "DNS poisoning complete"
  hijack.sh: |
    #!/bin/bash
    # DNS hijacking script
    echo "Starting DNS hijacking..." > /tmp/hijack.log
    # Simulate DNS hijacking
    echo "10.0.0.1 hijacked.example.com" >> /host/etc/hosts
    echo "DNS hijacking complete"
  spoof.sh: |
    #!/bin/bash
    # DNS spoofing script
    echo "Starting DNS spoofing..." > /tmp/spoof.log
    # Simulate DNS spoofing
    echo "192.168.1.1 spoofed.example.com" >> /host/etc/hosts
    echo "DNS spoofing complete"
  dns.conf: |
    # Malicious DNS configuration
    nameserver 127.0.0.1
    nameserver 8.8.8.8
    search malicious.local
---
# VULNERABLE: Secrets for DNS poisoning
apiVersion: v1
kind: Secret
metadata:
  name: dns-poisoning-secrets
  namespace: dns-poisoning-lab
type: Opaque
data:
  dns-key: ZG5zLXBvaXNvbi1rZXk=  # base64: dns-poison-key
  hijack-token: aGlqYWNrLXRva2VuLTEyMzQ1  # base64: hijack-token-12345
  spoof-password: c3Bvb2YtcGFzc3dvcmQ=  # base64: spoof-password
---
# VULNERABLE: ConfigMap with DNS poisoning information
apiVersion: v1
kind: ConfigMap
metadata:
  name: dns-poisoning-config
  namespace: dns-poisoning-lab
data:
  dns.poisoning.info: |
    DNS poisoning attack vectors:
    - Cache poisoning
    - DNS hijacking
    - DNS spoofing
    - Traffic redirection
    - Malicious records
  malicious.dns: 127.0.0.1
  hijack.target: hijacked.example.com
  spoof.target: spoofed.example.com
  security.level: high-risk
