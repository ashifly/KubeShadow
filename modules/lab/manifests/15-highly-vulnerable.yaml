apiVersion: v1
kind: Namespace
metadata:
  name: highly-vulnerable-lab
  labels:
    name: highly-vulnerable-lab
    security-level: critical
---
# VULNERABLE: Service account with excessive permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vulnerable-sa
  namespace: highly-vulnerable-lab
automountServiceAccountToken: true  # VULNERABLE: Unnecessary token mounting
---
# VULNERABLE: Overly permissive role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vulnerable-role
  namespace: highly-vulnerable-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vulnerable-role-binding
  namespace: highly-vulnerable-lab
subjects:
- kind: ServiceAccount
  name: vulnerable-sa
  namespace: highly-vulnerable-lab
roleRef:
  kind: Role
  name: vulnerable-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Highly vulnerable pod with all security issues
apiVersion: v1
kind: Pod
metadata:
  name: highly-vulnerable-pod
  namespace: highly-vulnerable-lab
  labels:
    app: highly-vulnerable
    security-level: critical
spec:
  serviceAccountName: vulnerable-sa
  automountServiceAccountToken: true  # VULNERABLE: Unnecessary token mounting
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0  # VULNERABLE: Running as root group
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
  initContainers:
  - name: malicious-init
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "echo 'malicious init container' > /host/etc/malicious.txt && chmod 777 /host/etc/malicious.txt"]
    securityContext:
      runAsUser: 0  # VULNERABLE: Init container as root
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true  # VULNERABLE: Privileged init container
      capabilities:
        add:
        - ALL
        drop: []
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
    - name: host-root
      mountPath: /host/root
    - name: host-var-run
      mountPath: /host/var/run
  containers:
  - name: vulnerable-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: SECRET_KEY
      value: "super-secret-key-12345"
    - name: DB_PASSWORD
      value: "admin123"
    - name: API_KEY
      value: "sk-1234567890abcdef"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-root
      mountPath: /host/root
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
    - name: host-var-lib
      mountPath: /host/var/lib
      readOnly: false
    - name: host-opt
      mountPath: /host/opt
      readOnly: false
    - name: host-tmp
      mountPath: /host/tmp
      readOnly: false
    - name: host-home
      mountPath: /host/home
      readOnly: false
    - name: host-usr
      mountPath: /host/usr
      readOnly: false
    - name: host-bin
      mountPath: /host/bin
      readOnly: false
    - name: host-sbin
      mountPath: /host/sbin
      readOnly: false
    - name: host-lib
      mountPath: /host/lib
      readOnly: false
    - name: host-lib64
      mountPath: /host/lib64
      readOnly: false
    - name: host-var-log
      mountPath: /host/var/log
      readOnly: false
    - name: host-etc-kubernetes
      mountPath: /host/etc/kubernetes
      readOnly: false
    - name: host-var-lib-kubelet
      mountPath: /host/var/lib/kubelet
      readOnly: false
    - name: host-etc-docker
      mountPath: /host/etc/docker
      readOnly: false
    - name: host-var-lib-docker
      mountPath: /host/var/lib/docker
      readOnly: false
    - name: host-etc-systemd
      mountPath: /host/etc/systemd
      readOnly: false
    - name: host-var-lib-systemd
      mountPath: /host/var/lib/systemd
      readOnly: false
  volumes:
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-root
    hostPath:
      path: /root  # VULNERABLE: Host path mount
  - name: host-var-run
    hostPath:
      path: /var/run  # VULNERABLE: Host path mount
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  - name: host-var-lib
    hostPath:
      path: /var/lib
  - name: host-opt
    hostPath:
      path: /opt
  - name: host-tmp
    hostPath:
      path: /tmp
  - name: host-home
    hostPath:
      path: /home
  - name: host-usr
    hostPath:
      path: /usr
  - name: host-bin
    hostPath:
      path: /bin
  - name: host-sbin
    hostPath:
      path: /sbin
  - name: host-lib
    hostPath:
      path: /lib
  - name: host-lib64
    hostPath:
      path: /lib64
  - name: host-var-log
    hostPath:
      path: /var/log
  - name: host-etc-kubernetes
    hostPath:
      path: /etc/kubernetes
  - name: host-var-lib-kubelet
    hostPath:
      path: /var/lib/kubelet
  - name: host-etc-docker
    hostPath:
      path: /etc/docker
  - name: host-var-lib-docker
    hostPath:
      path: /var/lib/docker
  - name: host-etc-systemd
    hostPath:
      path: /etc/systemd
  - name: host-var-lib-systemd
    hostPath:
      path: /var/lib/systemd
  restartPolicy: Always
---
# VULNERABLE: Another pod with different security issues
apiVersion: v1
kind: Pod
metadata:
  name: vulnerable-pod-2
  namespace: highly-vulnerable-lab
  labels:
    app: vulnerable-pod-2
    security-level: critical
spec:
  serviceAccountName: vulnerable-sa
  automountServiceAccountToken: true  # VULNERABLE: Unnecessary token mounting
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
    privileged: true  # VULNERABLE: Privileged container
    capabilities:
      add:
      - ALL  # VULNERABLE: All capabilities
      drop: []
    readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
  containers:
  - name: vulnerable-container-2
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: SECRET_KEY
      value: "super-secret-key-12345"
    - name: DB_PASSWORD
      value: "admin123"
    - name: API_KEY
      value: "sk-1234567890abcdef"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-root
      mountPath: /host/root
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-root
    hostPath:
      path: /root  # VULNERABLE: Host path mount
  - name: host-var-run
    hostPath:
      path: /var/run  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# Secrets for testing
apiVersion: v1
kind: Secret
metadata:
  name: vulnerable-secrets
  namespace: highly-vulnerable-lab
type: Opaque
data:
  root-password: dG9vcg==  # base64: toor
  ssh-key: c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDNw==  # base64: ssh-rsa AAAAB3NzaC1yc2EAAAADAQ
  api-token: c2stMTIzNDU2Nzg5MGFiY2RlZg==  # base64: sk-1234567890abcdef
  db-credentials: YWRtaW4xMjM=  # base64: admin123
---
# ConfigMap with sensitive information
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerable-config
  namespace: highly-vulnerable-lab
data:
  app.properties: |
    database.url=postgres://admin:admin123@db:5432/sensitive_data
    api.endpoint=https://api.example.com/v1
    api.key=sk-1234567890abcdef
    jwt.secret=super-secret-jwt-secret
    debug.enabled=true
    debug.level=verbose
    security.disabled=true
    host.access.enabled=true
  environment: production
  region: us-west-2
  cluster: kubeshadow-lab
  security.level: critical
