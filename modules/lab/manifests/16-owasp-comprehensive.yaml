# Comprehensive OWASP Top 10 Lab Environment
# This manifest creates a complex lab environment with vulnerabilities for all OWASP Top 10 categories

apiVersion: v1
kind: Namespace
metadata:
  name: owasp-lab
  labels:
    name: owasp-lab
    security-level: critical
---
# K01 - Insecure Workload Configurations
apiVersion: apps/v1
kind: Deployment
metadata:
  name: insecure-workloads
  namespace: owasp-lab
spec:
  replicas: 3
  selector:
    matchLabels:
      app: insecure-workloads
  template:
    metadata:
      labels:
        app: insecure-workloads
    spec:
      serviceAccountName: vulnerable-sa
      hostNetwork: true  # K01: Host network access
      hostPID: true      # K01: Host PID namespace
      hostIPC: true      # K01: Host IPC namespace
      securityContext:
        runAsUser: 0     # K01: Running as root
        runAsNonRoot: false
        allowPrivilegeEscalation: true
        privileged: true # K01: Privileged containers
        capabilities:
          add: ["ALL"]   # K01: All capabilities
      containers:
      - name: vulnerable-app
        image: nginx:latest  # K02: Latest tag (supply chain risk)
        imagePullPolicy: Always  # K01: Always pull policy
        securityContext:
          runAsUser: 0
          runAsNonRoot: false
          allowPrivilegeEscalation: true
          privileged: true
          capabilities:
            add: ["SYS_ADMIN", "NET_ADMIN", "SYS_CHROOT"]
        env:
        - name: SECRET_KEY
          value: "super-secret-key-12345"  # K08: Secret in env var
        - name: DB_PASSWORD
          value: "admin123"               # K08: Secret in env var
        volumeMounts:
        - name: host-etc
          mountPath: /host/etc            # K01: HostPath mount
        - name: host-root
          mountPath: /host/root           # K01: HostPath mount
        - name: host-var-run
          mountPath: /host/var/run        # K01: HostPath mount
      volumes:
      - name: host-etc
        hostPath:
          path: /etc                      # K01: HostPath mount
      - name: host-root
        hostPath:
          path: /root                     # K01: HostPath mount
      - name: host-var-run
        hostPath:
          path: /var/run                  # K01: HostPath mount
---
# K02 - Supply Chain Vulnerabilities
apiVersion: apps/v1
kind: Deployment
metadata:
  name: supply-chain-vulns
  namespace: owasp-lab
spec:
  replicas: 2
  selector:
    matchLabels:
      app: supply-chain-vulns
  template:
    metadata:
      labels:
        app: supply-chain-vulns
    spec:
      containers:
      - name: latest-image
        image: nginx:latest               # K02: Latest tag
        imagePullPolicy: Always
      - name: unsigned-image
        image: vulnerable-app:latest      # K02: Unsigned image
        imagePullPolicy: Always
      - name: mutable-registry
        image: registry.example.com/app:latest  # K02: Mutable registry
        imagePullPolicy: Always
---
# K03 - Overly Permissive RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cluster-admin-sa
  namespace: owasp-lab
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-admin-role
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]                           # K03: Overly permissive
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "exec"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-admin-binding
subjects:
- kind: ServiceAccount
  name: cluster-admin-sa
  namespace: owasp-lab
roleRef:
  kind: ClusterRole
  name: cluster-admin-role
  apiGroup: rbac.authorization.k8s.io
---
# K04 - Lack of Centralized Policy Enforcement
# Intentionally missing NetworkPolicies, PodSecurityPolicies, and OPA policies
---
# K05 - Inadequate Logging and Monitoring
apiVersion: apps/v1
kind: Deployment
metadata:
  name: no-logging-app
  namespace: owasp-lab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: no-logging-app
  template:
    metadata:
      labels:
        app: no-logging-app
    spec:
      containers:
      - name: silent-app
        image: alpine:latest
        command: ["/bin/sh"]
        args: ["-c", "while true; do echo 'no audit logging'; sleep 60; done"]
        # No logging configuration - K05 vulnerability
---
# K06 - Broken Authentication Mechanisms
apiVersion: v1
kind: ServiceAccount
metadata:
  name: anonymous-sa
  namespace: owasp-lab
  annotations:
    kubernetes.io/service-account.name: anonymous-sa
---
# K07 - Missing Network Segmentation Controls
apiVersion: v1
kind: Service
metadata:
  name: exposed-service
  namespace: owasp-lab
spec:
  type: NodePort                    # K07: Exposed service
  ports:
  - name: http
    port: 80
    targetPort: 8080
    nodePort: 30090
  selector:
    app: insecure-workloads
---
apiVersion: v1
kind: Service
metadata:
  name: loadbalancer-service
  namespace: owasp-lab
spec:
  type: LoadBalancer                 # K07: Public LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: supply-chain-vulns
---
# K08 - Secrets Management Failures
apiVersion: v1
kind: Secret
metadata:
  name: exposed-secrets
  namespace: owasp-lab
type: Opaque
data:
  root-password: dG9vcg==              # K08: Base64 encoded "toor"
  ssh-key: c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDNw==
  api-token: c2stMTIzNDU2Nzg5MGFiY2RlZg==
  db-credentials: YWRtaW4xMjM=
---
# ConfigMap with secrets (K08 vulnerability)
apiVersion: v1
kind: ConfigMap
metadata:
  name: secrets-in-configmap
  namespace: owasp-lab
data:
  database-url: "postgres://admin:admin123@db:5432/sensitive_data"
  api-key: "sk-1234567890abcdef"
  jwt-secret: "super-secret-jwt-secret"
  aws-access-key: "AKIAIOSFODNHDEEGAJOR"
  aws-secret-key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
---
# K09 - Misconfigured Cluster Components
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: vulnerable-webhook
webhooks:
- name: vulnerable.example.com
  clientConfig:
    url: "https://vulnerable-webhook.example.com/validate"
    caBundle: ""                      # K09: Empty caBundle
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["*"]
    apiVersions: ["*"]
    resources: ["*"]                  # K09: Overly broad resources
  failurePolicy: Ignore              # K09: Ignore failures
  sideEffects: None
  admissionReviewVersions: ["v1"]
---
# K10 - Outdated and Vulnerable Components
apiVersion: apps/v1
kind: Deployment
metadata:
  name: outdated-components
  namespace: owasp-lab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: outdated-components
  template:
    metadata:
      labels:
        app: outdated-components
    spec:
      containers:
      - name: old-nginx
        image: nginx:1.14.2           # K10: Outdated image
        imagePullPolicy: Always
      - name: vulnerable-app
        image: vulnerable-app:1.0.0   # K10: Vulnerable version
        imagePullPolicy: Always
---
# Additional vulnerable configurations for comprehensive testing
apiVersion: v1
kind: Pod
metadata:
  name: comprehensive-vuln-pod
  namespace: owasp-lab
  labels:
    app: comprehensive-vuln
spec:
  serviceAccountName: cluster-admin-sa
  hostNetwork: true                   # K01: Host network
  hostPID: true                       # K01: Host PID
  hostIPC: true                       # K01: Host IPC
  securityContext:
    runAsUser: 0                      # K01: Root user
    runAsGroup: 0
    runAsNonRoot: false
  initContainers:
  - name: malicious-init
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "echo 'malicious init' > /host/etc/malicious.txt"]
    securityContext:
      runAsUser: 0
      privileged: true
      capabilities:
        add: ["SYS_ADMIN", "SYS_CHROOT"]
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
  containers:
  - name: vulnerable-container
    image: nginx:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: SECRET_KEY
      value: "super-secret-key-12345"  # K08: Secret in env
    - name: DB_PASSWORD
      value: "admin123"               # K08: Secret in env
    - name: API_KEY
      value: "sk-1234567890abcdef"    # K08: Secret in env
    securityContext:
      runAsUser: 0                     # K01: Root user
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true
      capabilities:
        add: ["SYS_ADMIN", "NET_ADMIN", "SYS_CHROOT", "DAC_OVERRIDE"]
      readOnlyRootFilesystem: false
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
      readOnly: false
    - name: host-root
      mountPath: /host/root
      readOnly: false
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
  volumes:
  - name: host-etc
    hostPath:
      path: /etc                       # K01: HostPath mount
  - name: host-root
    hostPath:
      path: /root                      # K01: HostPath mount
  - name: host-var-run
    hostPath:
      path: /var/run                   # K01: HostPath mount
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  restartPolicy: Always
---
# Network exposure for K07 testing
apiVersion: v1
kind: Service
metadata:
  name: comprehensive-exposed-service
  namespace: owasp-lab
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30081
  selector:
    app: comprehensive-vuln
---
# Additional secrets for K08 testing
apiVersion: v1
kind: Secret
metadata:
  name: comprehensive-secrets
  namespace: owasp-lab
type: Opaque
data:
  root-password: dG9vcg==
  ssh-private-key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t
  api-token: c2stMTIzNDU2Nzg5MGFiY2RlZg==
  database-url: cG9zdGdyZXM6Ly9hZG1pbjphZG1pbjEyM0BkYjo1NDMyL3NlbnNpdGl2ZV9kYXRh
  jwt-secret: c3VwZXItc2VjcmV0LWp3dC1zZWNyZXQ=
  aws-credentials: QUtJQUlPU0ZPRE5IREVBR0VKQU9SOndKYWxyWFV0bkZFTUkvSzdNREVORy9iUHhSZmlDWUVYQU1QTEVLQVk=
---
# ConfigMap with more secrets (K08)
apiVersion: v1
kind: ConfigMap
metadata:
  name: comprehensive-secrets-configmap
  namespace: owasp-lab
data:
  database-url: "postgres://admin:admin123@db:5432/sensitive_data"
  api-endpoint: "https://api.example.com/v1"
  api-key: "sk-1234567890abcdef"
  jwt-secret: "super-secret-jwt-secret"
  debug-enabled: "true"
  debug-level: "verbose"
  security-disabled: "true"
  host-access-enabled: "true"
  environment: "production"
  region: "us-west-2"
  cluster: "kubeshadow-lab"
  security-level: "critical"
  aws-access-key: "AKIAIOSFODNHDEEGAJOR"
  aws-secret-key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
  gcp-service-account: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9"
  azure-client-id: "12345678-1234-1234-1234-123456789012"
  azure-client-secret: "super-secret-azure-key"
