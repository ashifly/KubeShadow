# Advanced Vulnerability Misconfigurations Lab
# Complex security misconfigurations and advanced attack scenarios
apiVersion: v1
kind: Namespace
metadata:
  name: advanced-vuln-lab
  labels:
    name: advanced-vuln-lab
    purpose: advanced-vulnerability-testing
    security-level: critical
---
# VULNERABLE: Service account with cluster-admin permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cluster-admin-sa
  namespace: advanced-vuln-lab
automountServiceAccountToken: true
---
# VULNERABLE: ClusterRole with excessive permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-admin-role
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "exec"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["endpoints"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["daemonsets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources: ["statefulsets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["policy"]
  resources: ["podsecuritypolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["mutatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-admin-binding
subjects:
- kind: ServiceAccount
  name: cluster-admin-sa
  namespace: advanced-vuln-lab
roleRef:
  kind: ClusterRole
  name: cluster-admin-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Pod with all security misconfigurations
apiVersion: v1
kind: Pod
metadata:
  name: advanced-vulnerable-pod
  namespace: advanced-vuln-lab
  labels:
    app: advanced-vulnerable
    security-level: critical
spec:
  serviceAccountName: cluster-admin-sa
  automountServiceAccountToken: true  # VULNERABLE: Unnecessary token mounting
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  dnsPolicy: "None"  # VULNERABLE: Custom DNS policy
  dnsConfig:
    nameservers:
    - "8.8.8.8"
    - "1.1.1.1"
    searches:
    - "malicious.local"
    options:
    - name: "ndots"
      value: "2"
    - name: "edns0"
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
    seLinuxOptions:
      level: "s0:c123,c456"  # VULNERABLE: Custom SELinux context
  initContainers:
  - name: malicious-init
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "echo 'malicious init container' > /host/etc/malicious.txt && chmod 777 /host/etc/malicious.txt"]
    securityContext:
      runAsUser: 0  # VULNERABLE: Init container as root
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true  # VULNERABLE: Privileged init container
      capabilities:
        add:
        - ALL
        drop: []
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
    - name: host-root
      mountPath: /host/root
    - name: host-var-run
      mountPath: /host/var/run
  containers:
  - name: vulnerable-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
      protocol: TCP
    - containerPort: 8443
      protocol: TCP
    env:
    - name: SECRET_KEY
      value: "super-secret-key-12345"
    - name: DB_PASSWORD
      value: "admin123"
    - name: API_KEY
      value: "sk-1234567890abcdef"
    - name: AWS_ACCESS_KEY_ID
      value: "AKIAIOSFODNHDEEGAJOR"
    - name: AWS_SECRET_ACCESS_KEY
      value: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    - name: GCP_SERVICE_ACCOUNT_KEY
      value: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9"
    - name: AZURE_CLIENT_ID
      value: "12345678-1234-1234-1234-123456789012"
    - name: AZURE_CLIENT_SECRET
      value: "super-secret-azure-key"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-root
      mountPath: /host/root
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var-run
      mountPath: /host/var/run
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
    - name: host-var-lib
      mountPath: /host/var/lib
      readOnly: false
    - name: host-opt
      mountPath: /host/opt
      readOnly: false
    - name: host-tmp
      mountPath: /host/tmp
      readOnly: false
    - name: host-home
      mountPath: /host/home
      readOnly: false
    - name: host-usr
      mountPath: /host/usr
      readOnly: false
    - name: host-bin
      mountPath: /host/bin
      readOnly: false
    - name: host-sbin
      mountPath: /host/sbin
      readOnly: false
    - name: host-lib
      mountPath: /host/lib
      readOnly: false
    - name: host-lib64
      mountPath: /host/lib64
      readOnly: false
    - name: host-var-log
      mountPath: /host/var/log
      readOnly: false
    - name: host-etc-kubernetes
      mountPath: /host/etc/kubernetes
      readOnly: false
    - name: host-var-lib-kubelet
      mountPath: /host/var/lib/kubelet
      readOnly: false
    - name: host-etc-docker
      mountPath: /host/etc/docker
      readOnly: false
    - name: host-var-lib-docker
      mountPath: /host/var/lib/docker
      readOnly: false
    - name: host-etc-systemd
      mountPath: /host/etc/systemd
      readOnly: false
    - name: host-var-lib-systemd
      mountPath: /host/var/lib/systemd
      readOnly: false
    - name: docker-socket
      mountPath: /var/run/docker.sock
      readOnly: false  # VULNERABLE: Writable Docker socket
    - name: kubelet-socket
      mountPath: /var/lib/kubelet/device-plugins/kubelet.sock
      readOnly: false  # VULNERABLE: Writable kubelet socket
    - name: etcd-socket
      mountPath: /var/lib/etcd
      readOnly: false  # VULNERABLE: Writable etcd socket
    resources:
      requests:
        memory: "1Gi"  # VULNERABLE: High memory request
        cpu: "1000m"   # VULNERABLE: High CPU request
        nvidia.com/gpu: 2  # VULNERABLE: GPU request
      limits:
        memory: "4Gi"  # VULNERABLE: Very high memory limit
        cpu: "4000m"   # VULNERABLE: Very high CPU limit
        nvidia.com/gpu: 4  # VULNERABLE: Multiple GPU limit
  volumes:
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-root
    hostPath:
      path: /root  # VULNERABLE: Host path mount
  - name: host-var-run
    hostPath:
      path: /var/run  # VULNERABLE: Host path mount
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  - name: host-var-lib
    hostPath:
      path: /var/lib
  - name: host-opt
    hostPath:
      path: /opt
  - name: host-tmp
    hostPath:
      path: /tmp
  - name: host-home
    hostPath:
      path: /home
  - name: host-usr
    hostPath:
      path: /usr
  - name: host-bin
    hostPath:
      path: /bin
  - name: host-sbin
    hostPath:
      path: /sbin
  - name: host-lib
    hostPath:
      path: /lib
  - name: host-lib64
    hostPath:
      path: /lib64
  - name: host-var-log
    hostPath:
      path: /var/log
  - name: host-etc-kubernetes
    hostPath:
      path: /etc/kubernetes
  - name: host-var-lib-kubelet
    hostPath:
      path: /var/lib/kubelet
  - name: host-etc-docker
    hostPath:
      path: /etc/docker
  - name: host-var-lib-docker
    hostPath:
      path: /var/lib/docker
  - name: host-etc-systemd
    hostPath:
      path: /etc/systemd
  - name: host-var-lib-systemd
    hostPath:
      path: /var/lib/systemd
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock  # VULNERABLE: Docker socket mount
  - name: kubelet-socket
    hostPath:
      path: /var/lib/kubelet/device-plugins/kubelet.sock  # VULNERABLE: Kubelet socket mount
  - name: etcd-socket
    hostPath:
      path: /var/lib/etcd  # VULNERABLE: ETCD socket mount
  restartPolicy: Always
---
# VULNERABLE: Pod with sidecar injection vulnerability
apiVersion: v1
kind: Pod
metadata:
  name: sidecar-vulnerable-pod
  namespace: advanced-vuln-lab
  labels:
    app: sidecar-vulnerable
    security-level: critical
spec:
  serviceAccountName: cluster-admin-sa
  containers:
  - name: main-container
    image: nginx:alpine
    ports:
    - containerPort: 80
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true
      capabilities:
        add:
        - ALL
        drop: []
      readOnlyRootFilesystem: false
    volumeMounts:
    - name: shared-data
      mountPath: /shared
      readOnly: false
  - name: sidecar-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    securityContext:
      runAsUser: 0  # VULNERABLE: Sidecar as root
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true
      capabilities:
        add:
        - ALL
        drop: []
      readOnlyRootFilesystem: false
    volumeMounts:
    - name: shared-data
      mountPath: /shared
      readOnly: false
    - name: host-root
      mountPath: /host
      readOnly: false
  volumes:
  - name: shared-data
    emptyDir: {}
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Pod with admission controller bypass
apiVersion: v1
kind: Pod
metadata:
  name: admission-bypass-pod
  namespace: advanced-vuln-lab
  labels:
    app: admission-bypass
    security-level: critical
  annotations:
    admission.kubernetes.io/ignore: "true"  # VULNERABLE: Bypass admission controllers
    pod-security.kubernetes.io/enforce: "privileged"  # VULNERABLE: Override security policy
spec:
  serviceAccountName: cluster-admin-sa
  hostNetwork: true
  hostPID: true
  hostIPC: true
  securityContext:
    runAsUser: 0
    runAsGroup: 0
    runAsNonRoot: false
  containers:
  - name: bypass-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    securityContext:
      runAsUser: 0
      runAsGroup: 0
      runAsNonRoot: false
      allowPrivilegeEscalation: true
      privileged: true
      capabilities:
        add:
        - ALL
        drop: []
      readOnlyRootFilesystem: false
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false
  volumes:
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Service exposing vulnerable pods
apiVersion: v1
kind: Service
metadata:
  name: advanced-vulnerable-service
  namespace: advanced-vuln-lab
  labels:
    app: advanced-vulnerable
spec:
  type: NodePort  # VULNERABLE: NodePort exposure
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    nodePort: 30089
    protocol: TCP
  - name: https
    port: 8443
    targetPort: 8443
    nodePort: 30090
    protocol: TCP
  selector:
    app: advanced-vulnerable
---
# VULNERABLE: Service exposing sidecar pods
apiVersion: v1
kind: Service
metadata:
  name: sidecar-vulnerable-service
  namespace: advanced-vuln-lab
  labels:
    app: sidecar-vulnerable
spec:
  type: LoadBalancer  # VULNERABLE: LoadBalancer exposure
  ports:
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
  selector:
    app: sidecar-vulnerable
---
# VULNERABLE: Secrets with sensitive information
apiVersion: v1
kind: Secret
metadata:
  name: advanced-vulnerable-secrets
  namespace: advanced-vuln-lab
type: Opaque
data:
  root-password: dG9vcg==  # base64: toor
  ssh-key: c3NoLXJzYSBBQUFBQjNOemFDMXljMkVBQUFBREFRQUJBQUFCZ1FDNw==  # base64: ssh-rsa AAAAB3NzaC1yc2EAAAADAQ
  api-token: c2stMTIzNDU2Nzg5MGFiY2RlZg==  # base64: sk-1234567890abcdef
  db-credentials: YWRtaW4xMjM=  # base64: admin123
  aws-credentials: QUtJQUlPU0ZPRE5IREVBR0VKQU9SOndKYWxyWFV0bkZFTUkvSzdNREVORy9iUHhSZmlDWUVYQU1QTEVLQVk=  # base64: AKIAIOSFODNHDEEGAJOR:wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
  gcp-credentials: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9  # base64: JWT token
  azure-credentials: MTIzNDU2NzgtMTIzNC0xMjM0LTEyMzQtMTIzNDU2Nzg5MDEyOnN1cGVyLXNlY3JldC1henVyZS1rZXk=  # base64: 12345678-1234-1234-1234-123456789012:super-secret-azure-key
---
# VULNERABLE: ConfigMap with sensitive information
apiVersion: v1
kind: ConfigMap
metadata:
  name: advanced-vulnerable-config
  namespace: advanced-vuln-lab
data:
  app.properties: |
    database.url=postgres://admin:admin123@db:5432/sensitive_data
    api.endpoint=https://api.example.com/v1
    api.key=sk-1234567890abcdef
    jwt.secret=super-secret-jwt-secret
    aws.access.key=AKIAIOSFODNHDEEGAJOR
    aws.secret.key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
    gcp.service.account=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9
    azure.client.id=12345678-1234-1234-1234-123456789012
    azure.client.secret=super-secret-azure-key
    debug.enabled=true
    debug.level=verbose
    security.disabled=true
    host.access.enabled=true
    privilege.escalation.enabled=true
    container.escape.enabled=true
  environment: production
  region: us-west-2
  cluster: kubeshadow-lab
  security.level: critical
  admission.controller.bypass: enabled
  sidecar.injection: enabled
  host.network.access: enabled
  privileged.containers: enabled
