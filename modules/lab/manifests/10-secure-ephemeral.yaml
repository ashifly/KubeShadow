apiVersion: v1
kind: Namespace
metadata:
  name: secure-ephemeral-lab
  labels:
    name: secure-ephemeral-lab
    security-level: secure
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
---
# SECURE: Minimal service account for debugging
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secure-debug-sa
  namespace: secure-ephemeral-lab
---
# SECURE: Minimal role with only necessary permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secure-debug-role
  namespace: secure-ephemeral-lab
rules:
# Only allow ephemeral containers on specific pods
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
  resourceNames: ["web-app", "database"]  # Restrict to specific pods
- apiGroups: [""]
  resources: ["pods/ephemeralcontainers"]
  verbs: ["get", "list", "create"]
  resourceNames: ["web-app", "database"]  # Restrict to specific pods
# No exec, portforward, or log access
# No secrets, configmaps, or other sensitive resources
---
# SECURE: Role binding with minimal scope
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secure-debug-role-binding
  namespace: secure-ephemeral-lab
subjects:
- kind: ServiceAccount
  name: secure-debug-sa
  namespace: secure-ephemeral-lab
roleRef:
  kind: Role
  name: secure-debug-role
  apiGroup: rbac.authorization.k8s.io
---
# SECURE: Pod with proper security context
apiVersion: v1
kind: Pod
metadata:
  name: secure-web-app
  namespace: secure-ephemeral-lab
  labels:
    app: secure-web-app
    security-level: secure
spec:
  serviceAccountName: secure-debug-sa
  containers:
  - name: web-server
    image: nginx:1.21
    ports:
    - containerPort: 80
    env:
    - name: SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: secure-app-secrets
          key: secret-key
    volumeMounts:
    - name: app-data
      mountPath: /var/www/html
    - name: secrets
      mountPath: /etc/secrets
      readOnly: true
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
  volumes:
  - name: app-data
    emptyDir: {}
  - name: secrets
    secret:
      secretName: secure-app-secrets
  restartPolicy: Always
---
# SECURE: Pod with minimal privileges
apiVersion: v1
kind: Pod
metadata:
  name: secure-database
  namespace: secure-ephemeral-lab
  labels:
    app: secure-database
    security-level: secure
spec:
  serviceAccountName: secure-debug-sa
  containers:
  - name: postgres
    image: postgres:13
    ports:
    - containerPort: 5432
    env:
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: secure-db-secrets
          key: password
    - name: POSTGRES_USER
      valueFrom:
        secretKeyRef:
          name: secure-db-secrets
          key: username
    - name: POSTGRES_DB
      value: "secure_data"
    volumeMounts:
    - name: db-data
      mountPath: /var/lib/postgresql/data
    securityContext:
      runAsUser: 999
      runAsGroup: 999
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
        - ALL
  volumes:
  - name: db-data
    emptyDir: {}
  restartPolicy: Always
---
# SECURE: Secrets with proper encryption
apiVersion: v1
kind: Secret
metadata:
  name: secure-app-secrets
  namespace: secure-ephemeral-lab
type: Opaque
data:
  secret-key: c2VjdXJlLXNlY3JldC1rZXk=  # base64: secure-secret-key
  jwt-secret: c2VjdXJlLWp3dC1zZWNyZXQ=  # base64: secure-jwt-secret
---
apiVersion: v1
kind: Secret
metadata:
  name: secure-db-secrets
  namespace: secure-ephemeral-lab
type: Opaque
data:
  password: c2VjdXJlLWRiLXBhc3N3b3Jk  # base64: secure-db-password
  username: c2VjdXJlLXVzZXI=  # base64: secure-user
---
# SECURE: Network policy to restrict access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: secure-ephemeral-netpol
  namespace: secure-ephemeral-lab
spec:
  podSelector:
    matchLabels:
      app: secure-web-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: secure-ephemeral-lab
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: secure-ephemeral-lab
    ports:
    - protocol: TCP
      port: 5432
---
# SECURE: Pod Security Policy (if supported)
metadata:
  name: secure-ephemeral-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
