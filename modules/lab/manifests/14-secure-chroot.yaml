apiVersion: v1
kind: Namespace
metadata:
  name: secure-chroot-lab
  labels:
    name: secure-chroot-lab
    security-level: secure
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
---
# SECURE: Minimal service account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secure-escape-sa
  namespace: secure-chroot-lab
---
# SECURE: Minimal role with restricted permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secure-escape-role
  namespace: secure-chroot-lab
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
  resourceNames: ["secure-app"]  # Restrict to specific pod
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
  resourceNames: ["secure-app"]  # Restrict to specific pod
# No secrets, configmaps, or other sensitive resources access
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secure-escape-role-binding
  namespace: secure-chroot-lab
subjects:
- kind: ServiceAccount
  name: secure-escape-sa
  namespace: secure-chroot-lab
roleRef:
  kind: Role
  name: secure-escape-role
  apiGroup: rbac.authorization.k8s.io
---
# SECURE: Pod with proper security context
apiVersion: v1
kind: Pod
metadata:
  name: secure-app
  namespace: secure-chroot-lab
  labels:
    app: secure-app
    security-level: secure
spec:
  serviceAccountName: secure-escape-sa
  containers:
  - name: secure-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: APP_SECRET
      valueFrom:
        secretKeyRef:
          name: secure-app-secrets
          key: secret-key
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: secure-db-secrets
          key: password
    volumeMounts:
    - name: app-data
      mountPath: /app/data
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
  volumes:
  - name: app-data
    emptyDir: {}
  restartPolicy: Always
---
# SECURE: Pod Security Policy
metadata:
  name: secure-chroot-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  allowedCapabilities:
    - NET_BIND_SERVICE
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
---
# SECURE: Network policy to restrict access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: secure-chroot-netpol
  namespace: secure-chroot-lab
spec:
  podSelector:
    matchLabels:
      app: secure-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: secure-chroot-lab
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: secure-chroot-lab
    ports:
    - protocol: TCP
      port: 8080
---
# SECURE: Secrets with proper encryption
apiVersion: v1
kind: Secret
metadata:
  name: secure-app-secrets
  namespace: secure-chroot-lab
type: Opaque
data:
  secret-key: c2VjdXJlLXNlY3JldC1rZXk=  # base64: secure-secret-key
  api-token: c2VjdXJlLWFwaS10b2tlbg==  # base64: secure-api-token
---
apiVersion: v1
kind: Secret
metadata:
  name: secure-db-secrets
  namespace: secure-chroot-lab
type: Opaque
data:
  password: c2VjdXJlLWRiLXBhc3N3b3Jk  # base64: secure-db-password
  username: c2VjdXJlLXVzZXI=  # base64: secure-user
---
# SECURE: ConfigMap with minimal data
apiVersion: v1
kind: ConfigMap
metadata:
  name: secure-app-config
  namespace: secure-chroot-lab
data:
  app.properties: |
    database.url=postgres://secure-user:secure-db-password@db:5432/secure_data
    api.endpoint=https://secure-api.example.com/v1
    debug.enabled=false
    debug.level=error
    chroot.escape.enabled=false
    host.access.enabled=false
  environment: production
  region: us-west-2
  cluster: kubeshadow-lab
  security.level: secure
