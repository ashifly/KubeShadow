# SSRF (Server-Side Request Forgery) Vulnerability Lab
apiVersion: v1
kind: Namespace
metadata:
  name: ssrf-lab
  labels:
    name: ssrf-lab
    purpose: ssrf-testing
    security-level: high-risk
---
# VULNERABLE: Service account with excessive permissions for SSRF testing
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ssrf-sa
  namespace: ssrf-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for SSRF exploitation
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ssrf-role
  namespace: ssrf-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ssrf-role-binding
  namespace: ssrf-lab
subjects:
- kind: ServiceAccount
  name: ssrf-sa
  namespace: ssrf-lab
roleRef:
  kind: Role
  name: ssrf-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Web application with SSRF vulnerability
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ssrf-webapp
  namespace: ssrf-lab
  labels:
    app: ssrf-webapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ssrf-webapp
  template:
    metadata:
      labels:
        app: ssrf-webapp
    spec:
      serviceAccountName: ssrf-sa
      containers:
      - name: ssrf-container
        image: nginx:alpine
        ports:
        - containerPort: 80
        env:
        - name: INTERNAL_API_URL
          value: "http://internal-api:8080"
        - name: METADATA_URL
          value: "http://169.254.169.254"
        - name: KUBERNETES_SERVICE_HOST
          value: "kubernetes.default.svc.cluster.local"
        - name: KUBERNETES_SERVICE_PORT
          value: "443"
        volumeMounts:
        - name: ssrf-script
          mountPath: /usr/share/nginx/html
        - name: vulnerable-config
          mountPath: /etc/nginx/conf.d
      volumes:
      - name: ssrf-script
        configMap:
          name: ssrf-webapp-script
      - name: vulnerable-config
        configMap:
          name: ssrf-nginx-config
---
# VULNERABLE: Internal API service (target for SSRF)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: internal-api
  namespace: ssrf-lab
  labels:
    app: internal-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: internal-api
  template:
    metadata:
      labels:
        app: internal-api
    spec:
      serviceAccountName: ssrf-sa
      containers:
      - name: internal-api-container
        image: alpine:latest
        command: ["/bin/sh"]
        args: ["-c", "while true; do echo 'Internal API running' > /tmp/api.log; sleep 3600; done"]
        env:
        - name: SECRET_TOKEN
          value: "internal-secret-token-12345"
        - name: DB_PASSWORD
          value: "internal-db-password"
        - name: API_KEY
          value: "sk-internal-abcdef123456"
        volumeMounts:
        - name: sensitive-data
          mountPath: /data
      volumes:
      - name: sensitive-data
        hostPath:
          path: /tmp
---
# VULNERABLE: Service exposing internal API
apiVersion: v1
kind: Service
metadata:
  name: internal-api
  namespace: ssrf-lab
  labels:
    app: internal-api
spec:
  selector:
    app: internal-api
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
---
# VULNERABLE: Service exposing SSRF webapp
apiVersion: v1
kind: Service
metadata:
  name: ssrf-webapp
  namespace: ssrf-lab
  labels:
    app: ssrf-webapp
spec:
  type: NodePort
  selector:
    app: ssrf-webapp
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30091
    protocol: TCP
---
# VULNERABLE: ConfigMap with SSRF vulnerable script
apiVersion: v1
kind: ConfigMap
metadata:
  name: ssrf-webapp-script
  namespace: ssrf-lab
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>SSRF Vulnerable Web Application</title>
    </head>
    <body>
        <h1>SSRF Vulnerable Web Application</h1>
        <p>This application is intentionally vulnerable to SSRF attacks.</p>
        <form action="/ssrf" method="POST">
            <label for="url">Enter URL to fetch:</label><br>
            <input type="text" id="url" name="url" value="http://internal-api:8080" style="width: 400px;"><br><br>
            <input type="submit" value="Fetch URL">
        </form>
        <h2>Vulnerable Endpoints:</h2>
        <ul>
            <li>POST /ssrf - SSRF vulnerable endpoint</li>
            <li>GET /metadata - Metadata endpoint</li>
            <li>GET /internal - Internal API access</li>
        </ul>
        <h2>Test URLs:</h2>
        <ul>
            <li>http://internal-api:8080 - Internal API</li>
            <li>http://169.254.169.254 - Cloud metadata</li>
            <li>http://kubernetes.default.svc.cluster.local - Kubernetes API</li>
        </ul>
    </body>
    </html>
---
# VULNERABLE: Nginx configuration with SSRF vulnerability
apiVersion: v1
kind: ConfigMap
metadata:
  name: ssrf-nginx-config
  namespace: ssrf-lab
data:
  ssrf.conf: |
    server {
        listen 80;
        server_name _;
        
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
        
        # VULNERABLE: SSRF endpoint
        location /ssrf {
            if ($request_method = POST) {
                return 200 "SSRF endpoint - vulnerable to internal network access";
            }
            return 405 "Method not allowed";
        }
        
        # VULNERABLE: Metadata endpoint
        location /metadata {
            return 200 "Metadata endpoint - vulnerable to cloud metadata access";
        }
        
        # VULNERABLE: Internal API access
        location /internal {
            return 200 "Internal API access - vulnerable to service discovery";
        }
    }
---
# VULNERABLE: Secrets for SSRF testing
apiVersion: v1
kind: Secret
metadata:
  name: ssrf-secrets
  namespace: ssrf-lab
type: Opaque
data:
  internal-token: aW50ZXJuYWwtc2VjcmV0LXRva2VuLTEyMzQ1  # base64: internal-secret-token-12345
  db-password: aW50ZXJuYWwtZGItcGFzc3dvcmQ=  # base64: internal-db-password
  api-key: c2staW50ZXJuYWwtYWJjZGVmMTIzNDU2  # base64: sk-internal-abcdef123456
---
# VULNERABLE: ConfigMap with sensitive information
apiVersion: v1
kind: ConfigMap
metadata:
  name: ssrf-config
  namespace: ssrf-lab
data:
  app.properties: |
    internal.api.url=http://internal-api:8080
    metadata.url=http://169.254.169.254
    kubernetes.api.url=http://kubernetes.default.svc.cluster.local
    debug.enabled=true
    security.disabled=true
    internal.access.enabled=true
  environment: lab
  security.level: vulnerable
