# Crypto Miner Vulnerability Lab
apiVersion: v1
kind: Namespace
metadata:
  name: crypto-miner-lab
  labels:
    name: crypto-miner-lab
    purpose: crypto-miner-testing
    security-level: high-risk
---
# VULNERABLE: Service account with excessive permissions for crypto mining
apiVersion: v1
kind: ServiceAccount
metadata:
  name: crypto-miner-sa
  namespace: crypto-miner-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for crypto mining
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: crypto-miner-role
  namespace: crypto-miner-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: crypto-miner-role-binding
  namespace: crypto-miner-lab
subjects:
- kind: ServiceAccount
  name: crypto-miner-sa
  namespace: crypto-miner-lab
roleRef:
  kind: Role
  name: crypto-miner-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Crypto miner pod with excessive resources
apiVersion: v1
kind: Pod
metadata:
  name: crypto-miner-pod
  namespace: crypto-miner-lab
  labels:
    app: crypto-miner
    security-level: high-risk
spec:
  serviceAccountName: crypto-miner-sa
  containers:
  - name: crypto-miner-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Mining cryptocurrency...' > /tmp/mining.log; sleep 3600; done"]
    env:
    - name: MINING_POOL
      value: "stratum+tcp://pool.example.com:4444"
    - name: WALLET_ADDRESS
      value: "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
    - name: MINING_ALGORITHM
      value: "sha256"
    - name: CPU_INTENSIVE
      value: "true"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    resources:
      requests:
        memory: "1Gi"  # VULNERABLE: High memory request
        cpu: "1000m"   # VULNERABLE: High CPU request
      limits:
        memory: "4Gi"  # VULNERABLE: Very high memory limit
        cpu: "4000m"   # VULNERABLE: Very high CPU limit
    volumeMounts:
    - name: mining-data
      mountPath: /data
      readOnly: false  # VULNERABLE: Writable mining data
    - name: host-tmp
      mountPath: /host/tmp
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: mining-data
    hostPath:
      path: /tmp/mining-data
  - name: host-tmp
    hostPath:
      path: /tmp  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: GPU miner pod
apiVersion: v1
kind: Pod
metadata:
  name: gpu-miner-pod
  namespace: crypto-miner-lab
  labels:
    app: gpu-miner
    security-level: high-risk
spec:
  serviceAccountName: crypto-miner-sa
  containers:
  - name: gpu-miner-container
    image: nvidia/cuda:11.0-base
    command: ["/bin/bash"]
    args: ["-c", "while true; do echo 'GPU mining...' > /tmp/gpu-mining.log; sleep 3600; done"]
    env:
    - name: GPU_MINING
      value: "enabled"
    - name: CUDA_DEVICES
      value: "0,1,2,3"
    - name: MINING_INTENSITY
      value: "100"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    resources:
      requests:
        memory: "2Gi"  # VULNERABLE: High memory request
        cpu: "2000m"   # VULNERABLE: High CPU request
        nvidia.com/gpu: 4  # VULNERABLE: Multiple GPU request
      limits:
        memory: "8Gi"  # VULNERABLE: Very high memory limit
        cpu: "8000m"   # VULNERABLE: Very high CPU limit
        nvidia.com/gpu: 4  # VULNERABLE: Multiple GPU limit
    volumeMounts:
    - name: gpu-mining-data
      mountPath: /data
      readOnly: false  # VULNERABLE: Writable mining data
    - name: host-dev
      mountPath: /host/dev
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: gpu-mining-data
    hostPath:
      path: /tmp/gpu-mining-data
  - name: host-dev
    hostPath:
      path: /dev  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Hidden miner pod (disguised as legitimate service)
apiVersion: v1
kind: Pod
metadata:
  name: nginx-proxy
  namespace: crypto-miner-lab
  labels:
    app: nginx-proxy
    security-level: medium-risk
spec:
  serviceAccountName: crypto-miner-sa
  containers:
  - name: nginx-container
    image: nginx:alpine
    ports:
    - containerPort: 80
    env:
    - name: HIDDEN_MINER
      value: "enabled"
    - name: DISGUISE_MODE
      value: "active"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    resources:
      requests:
        memory: "512Mi"  # VULNERABLE: High memory request
        cpu: "500m"      # VULNERABLE: High CPU request
      limits:
        memory: "2Gi"    # VULNERABLE: High memory limit
        cpu: "2000m"     # VULNERABLE: High CPU limit
    volumeMounts:
    - name: hidden-miner
      mountPath: /hidden
      readOnly: false  # VULNERABLE: Writable hidden miner
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: hidden-miner
    hostPath:
      path: /tmp/hidden-miner
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Mining pool connection pod
apiVersion: v1
kind: Pod
metadata:
  name: mining-pool-connector
  namespace: crypto-miner-lab
  labels:
    app: mining-pool-connector
    security-level: high-risk
spec:
  serviceAccountName: crypto-miner-sa
  containers:
  - name: pool-connector-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo 'Connecting to mining pool...' > /tmp/pool-conn.log; sleep 3600; done"]
    env:
    - name: POOL_URL
      value: "stratum+tcp://pool.example.com:4444"
    - name: WALLET_ADDRESS
      value: "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
    - name: WORKER_NAME
      value: "kubeshadow-miner"
    - name: PASSWORD
      value: "x"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    resources:
      requests:
        memory: "256Mi"  # VULNERABLE: Memory request
        cpu: "250m"      # VULNERABLE: CPU request
      limits:
        memory: "1Gi"    # VULNERABLE: Memory limit
        cpu: "1000m"     # VULNERABLE: CPU limit
    volumeMounts:
    - name: pool-data
      mountPath: /data
      readOnly: false  # VULNERABLE: Writable pool data
    - name: host-network
      mountPath: /host/network
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: pool-data
    hostPath:
      path: /tmp/pool-data
  - name: host-network
    hostPath:
      path: /proc/net  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Service exposing crypto miner
apiVersion: v1
kind: Service
metadata:
  name: crypto-miner-service
  namespace: crypto-miner-lab
  labels:
    app: crypto-miner
spec:
  type: NodePort
  selector:
    app: crypto-miner
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30084
    protocol: TCP
---
# VULNERABLE: Service exposing hidden miner
apiVersion: v1
kind: Service
metadata:
  name: nginx-proxy-service
  namespace: crypto-miner-lab
  labels:
    app: nginx-proxy
spec:
  type: NodePort
  selector:
    app: nginx-proxy
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30085
    protocol: TCP
---
# VULNERABLE: Secrets for crypto mining
apiVersion: v1
kind: Secret
metadata:
  name: crypto-miner-secrets
  namespace: crypto-miner-lab
type: Opaque
data:
  wallet-address: MUE1enAxZVA1UUdlZmlJRE1QVFRmVEw1U0xtdjhEaXZmTmE=  # base64: 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa
  pool-password: eA==  # base64: x
  mining-key: bWluaW5nLWtleS0xMjM0NQ==  # base64: mining-key-12345
---
# VULNERABLE: ConfigMap with crypto mining information
apiVersion: v1
kind: ConfigMap
metadata:
  name: crypto-miner-config
  namespace: crypto-miner-lab
data:
  mining.info: |
    Crypto mining configuration:
    - Mining pool: stratum+tcp://pool.example.com:4444
    - Wallet: 1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa
    - Algorithm: SHA256
    - Worker: kubeshadow-miner
  pool.config: |
    pool_url=stratum+tcp://pool.example.com:4444
    wallet_address=1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa
    worker_name=kubeshadow-miner
    password=x
  mining.algorithm: sha256
  mining.intensity: "100"
  security.level: high-risk
