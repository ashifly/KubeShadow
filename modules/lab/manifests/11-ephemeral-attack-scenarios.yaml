# Ephemeral Container Attack Scenarios
# Advanced ephemeral container exploitation techniques
apiVersion: v1
kind: Namespace
metadata:
  name: ephemeral-attack-lab
  labels:
    name: ephemeral-attack-lab
    purpose: ephemeral-attack-testing
    security-level: critical
---
# VULNERABLE: Service account with excessive permissions for ephemeral attacks
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ephemeral-attack-sa
  namespace: ephemeral-attack-lab
automountServiceAccountToken: true
---
# VULNERABLE: Overly permissive role for ephemeral container attacks
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ephemeral-attack-role
  namespace: ephemeral-attack-lab
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ephemeral-attack-role-binding
  namespace: ephemeral-attack-lab
subjects:
- kind: ServiceAccount
  name: ephemeral-attack-sa
  namespace: ephemeral-attack-lab
roleRef:
  kind: Role
  name: ephemeral-attack-role
  apiGroup: rbac.authorization.k8s.io
---
# VULNERABLE: Target pod for ephemeral container attacks
apiVersion: v1
kind: Pod
metadata:
  name: ephemeral-target-pod
  namespace: ephemeral-attack-lab
  labels:
    app: ephemeral-target
    security-level: vulnerable
spec:
  serviceAccountName: ephemeral-attack-sa
  containers:
  - name: target-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: TARGET_DATA
      value: "sensitive-target-data"
    - name: API_KEY
      value: "target-api-key-12345"
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
  restartPolicy: Always
---
# VULNERABLE: Pod with privileged ephemeral container access
apiVersion: v1
kind: Pod
metadata:
  name: privileged-ephemeral-pod
  namespace: ephemeral-attack-lab
  labels:
    app: privileged-ephemeral
    security-level: critical
spec:
  serviceAccountName: ephemeral-attack-sa
  hostNetwork: true  # VULNERABLE: Host network access
  hostPID: true  # VULNERABLE: Host PID namespace
  hostIPC: true  # VULNERABLE: Host IPC namespace
  securityContext:
    runAsUser: 0  # VULNERABLE: Running as root
    runAsGroup: 0
    runAsNonRoot: false  # VULNERABLE: Not running as non-root
  containers:
  - name: privileged-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    ports:
    - containerPort: 8080
    env:
    - name: PRIVILEGED_ACCESS
      value: "enabled"
    - name: EPHEMERAL_ATTACK
      value: "possible"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-var
      mountPath: /host/var
      readOnly: false  # VULNERABLE: Writable host mount
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
  volumes:
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  - name: host-var
    hostPath:
      path: /var  # VULNERABLE: Host path mount
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  restartPolicy: Always
---
# VULNERABLE: Pod with Docker socket access for ephemeral attacks
apiVersion: v1
kind: Pod
metadata:
  name: docker-socket-ephemeral-pod
  namespace: ephemeral-attack-lab
  labels:
    app: docker-socket-ephemeral
    security-level: critical
spec:
  serviceAccountName: ephemeral-attack-sa
  containers:
  - name: docker-socket-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: DOCKER_SOCKET_ACCESS
      value: "enabled"
    - name: EPHEMERAL_ATTACK
      value: "possible"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: docker-socket
      mountPath: /var/run/docker.sock
      readOnly: false  # VULNERABLE: Writable Docker socket
    - name: host-root
      mountPath: /host
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: docker-socket
    hostPath:
      path: /var/run/docker.sock  # VULNERABLE: Docker socket mount
  - name: host-root
    hostPath:
      path: /  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Pod with cgroup escape for ephemeral attacks
apiVersion: v1
kind: Pod
metadata:
  name: cgroup-escape-ephemeral-pod
  namespace: ephemeral-attack-lab
  labels:
    app: cgroup-escape-ephemeral
    security-level: critical
spec:
  serviceAccountName: ephemeral-attack-sa
  containers:
  - name: cgroup-escape-container
    image: alpine:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 3600; done"]
    env:
    - name: CGROUP_ESCAPE
      value: "possible"
    - name: EPHEMERAL_ATTACK
      value: "enabled"
    securityContext:
      runAsUser: 0  # VULNERABLE: Running as root
      runAsGroup: 0
      runAsNonRoot: false  # VULNERABLE: Not running as non-root
      allowPrivilegeEscalation: true  # VULNERABLE: Privilege escalation allowed
      privileged: true  # VULNERABLE: Privileged container
      capabilities:
        add:
        - ALL  # VULNERABLE: All capabilities
        drop: []
      readOnlyRootFilesystem: false  # VULNERABLE: Writable root filesystem
    volumeMounts:
    - name: host-proc
      mountPath: /host/proc
      readOnly: false
    - name: host-sys
      mountPath: /host/sys
      readOnly: false
    - name: host-dev
      mountPath: /host/dev
      readOnly: false
    - name: host-etc
      mountPath: /host/etc
      readOnly: false  # VULNERABLE: Writable host mount
  volumes:
  - name: host-proc
    hostPath:
      path: /proc
  - name: host-sys
    hostPath:
      path: /sys
  - name: host-dev
    hostPath:
      path: /dev
  - name: host-etc
    hostPath:
      path: /etc  # VULNERABLE: Host path mount
  restartPolicy: Always
---
# VULNERABLE: Service exposing ephemeral attack pods
apiVersion: v1
kind: Service
metadata:
  name: ephemeral-attack-service
  namespace: ephemeral-attack-lab
  labels:
    app: ephemeral-attack
spec:
  type: NodePort
  selector:
    app: privileged-ephemeral
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30088
    protocol: TCP
---
# VULNERABLE: Secrets for ephemeral attack testing
apiVersion: v1
kind: Secret
metadata:
  name: ephemeral-attack-secrets
  namespace: ephemeral-attack-lab
type: Opaque
data:
  attack-token: YXR0YWNrLXRva2VuLTEyMzQ1  # base64: attack-token-12345
  escape-key: ZXNjYXBlLWtleS1lcGhlbWVyYWw=  # base64: escape-key-ephemeral
  backdoor-password: YmFja2Rvb3ItcGFzc3dvcmQ=  # base64: backdoor-password
---
# VULNERABLE: ConfigMap with ephemeral attack information
apiVersion: v1
kind: ConfigMap
metadata:
  name: ephemeral-attack-config
  namespace: ephemeral-attack-lab
data:
  attack.info: |
    Ephemeral container attack techniques:
    - Privileged ephemeral containers
    - Docker socket access
    - Cgroup escape
    - Host filesystem access
    - Process namespace escape
  ephemeral.attack: enabled
  privilege.escalation: allowed
  host.access: enabled
  security.level: critical
